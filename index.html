<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TDCç’°å“©åŒ¯ x èˆªç©ºå¡æ¶ˆè²»ç´¯å“©å·¥å…· v12.6</title>

  <!-- å¤–éƒ¨è³‡æº -->
  <link href="[https://fonts.googleapis.com/css2?family=Varela+Round&family=Mali:wght@500;700&family=Noto+Sans+TC:wght@400;700;900&display=swap](https://fonts.googleapis.com/css2?family=Varela+Round&family=Mali:wght@500;700&family=Noto+Sans+TC:wght@400;700;900&display=swap)" rel="stylesheet">
  <link href="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css](https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css)" rel="stylesheet">

  <style>
    /* =========================
       æ’ç‰ˆé˜²ç¦¦ç³»çµ± (Previewer Fallback CSS)
       ========================= */
    .row { display: flex; flex-wrap: wrap; margin-left: -5px; margin-right: -5px; }
    .col-5 { width: 41.666%; padding-left: 5px; padding-right: 5px; box-sizing: border-box; }
    .col-6 { width: 50%; padding-left: 5px; padding-right: 5px; box-sizing: border-box; }
    .col-7 { width: 58.333%; padding-left: 5px; padding-right: 5px; box-sizing: border-box; }
    .col-12 { width: 100%; padding-left: 5px; padding-right: 5px; box-sizing: border-box; }
    .d-flex { display: flex !important; }
    .justify-content-between { justify-content: space-between !important; }
    .justify-content-center { justify-content: center !important; }
    .justify-content-evenly { justify-content: space-evenly !important; }
    .align-items-center { align-items: center !important; }
    .align-items-end { align-items: flex-end !important; }
    .gap-1 { gap: 0.25rem !important; }
    .gap-2 { gap: 0.5rem !important; }
    .w-100 { width: 100% !important; }
    .flex-grow-1 { flex-grow: 1 !important; }
    .flex-shrink-0 { flex-shrink: 0 !important; }
    .text-center { text-align: center !important; }
    .text-end { text-align: right !important; }
    .text-decoration-none { text-decoration: none !important; }
    
    .input-group { display: flex; align-items: stretch; width: 100%; }
    .input-group .form-control { flex: 1 1 auto; width: 1%; margin: 0; border-radius: 0; }
    .input-group > button:first-child, .input-group > span:first-child { border-top-right-radius: 0; border-bottom-right-radius: 0; margin-right: -2px; z-index: 2; }
    .input-group > input:last-child, .input-group > span:last-child { border-top-left-radius: 0; border-bottom-left-radius: 0; margin-left: -2px; }
    
    .m-0 { margin: 0 !important; }
    .mb-1 { margin-bottom: 0.25rem !important; } .mb-2 { margin-bottom: 0.5rem !important; } .mb-3 { margin-bottom: 1rem !important; } .mb-4 { margin-bottom: 1.5rem !important; }
    .mt-0 { margin-top: 0 !important; } .mt-1 { margin-top: 0.25rem !important; } .mt-2 { margin-top: 0.5rem !important; } .mt-3 { margin-top: 1rem !important; } .mt-4 { margin-top: 1.5rem !important; }
    .me-1 { margin-right: 0.25rem !important; } .me-2 { margin-right: 0.5rem !important; }
    .ms-1 { margin-left: 0.25rem !important; } .ms-2 { margin-left: 0.5rem !important; }
    .p-0 { padding: 0 !important; } .p-1 { padding: 0.25rem !important; } .p-2 { padding: 0.5rem !important; } .p-3 { padding: 1rem !important; } .p-4 { padding: 1.5rem !important; }
    .py-1 { padding-top: 0.25rem !important; padding-bottom: 0.25rem !important; } .py-3 { padding-top: 1rem !important; padding-bottom: 1rem !important; }
    .px-1 { padding-left: 0.25rem !important; padding-right: 0.25rem !important; } .px-2 { padding-left: 0.5rem !important; padding-right: 0.5rem !important; } .px-3 { padding-left: 1rem !important; padding-right: 1rem !important; } .px-4 { padding-left: 1.5rem !important; padding-right: 1.5rem !important; } .px-5 { padding-left: 3rem !important; padding-right: 3rem !important; }

    /* =========================
       å…§è¯ SVG åœ–ç¤ºæ¨£å¼
       ========================= */
    .lucide { 
      width: 1.2em; height: 1.2em; 
      display: inline-block; vertical-align: -0.2em; 
      fill: none; stroke: currentColor; 
      stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; 
    }
    .lucide-fill { fill: currentColor; stroke: none; }

    /* =========================
       CSS æ¨£å¼è¡¨ (ä¿ç•™ è«è˜­è¿ªç¾å­¸)
       ========================= */
    :root {
      --bg-main: #fffdf9; --bg-card: #ffffff;
      --primary: #60a5fa; --primary-dark: #2563eb;
      --text-header: #334155; --text-body: #475569; --text-light: #94a3b8;
      --shadow-draw: 3px 3px 0px rgba(0,0,0,0.06);
      --radius-box: 24px;
      --font-hand: 'Mali', cursive; --font-main: 'Varela Round', sans-serif;
      --m-sage: #84a59d; --m-clay: #f5cac3; --m-dusty: #95b8d1; --m-terra: #e5989b; --m-slate: #6d6875; --m-sand: #f2e9e4; --m-stone: #a5a58d;
    }

    body {
      background-color: var(--bg-main); color: var(--text-body); font-family: var(--font-main);
      min-height: 100vh; display: flex; flex-direction: column;
      background-image: radial-gradient(#e0f2fe 2px, transparent 2px); background-size: 24px 24px;
      -webkit-tap-highlight-color: transparent; padding-bottom: 100px; margin: 0;
    }

    h1,h2,h3,h4,h5,h6 { font-family: var(--font-hand); font-weight: 700; color: var(--text-header); margin-top: 0; }

    .header {
      background: #ffffff; padding: 15px 20px 25px 20px;
      border-bottom-left-radius: 36px; border-bottom-right-radius: 36px;
      position: sticky; top: 0; box-shadow: var(--shadow-draw); margin-bottom: 10px;
      display: flex; justify-content: space-between; align-items: center;
      height: 90px; border-bottom: 3px dashed #bae6fd; z-index: 100; box-sizing: border-box;
    }
    .header-icon {
      width: 40px; height: 40px; background: #eff6ff; border: 2px solid #bfdbfe;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--primary); font-size: 1.1rem; transform: rotate(-5deg); margin-right: 10px; flex-shrink: 0;
    }
    .header-title h5 { margin: 0; font-size: 1rem; color: var(--primary-dark); line-height: 1.2; }
    .header-title small { color: var(--text-light); font-size: 0.75rem; font-family: var(--font-hand); }

    .btn-header {
      background: #fff; border: 2px solid #e2e8f0; color: var(--text-body);
      font-weight: 700; font-family: var(--font-hand); font-size: 0.8rem;
      padding: 6px 12px; box-shadow: 2px 2px 0 #e2e8f0; border-radius: 16px;
      transition: 0.1s; white-space: nowrap; display: flex; align-items: center; cursor: pointer; text-decoration: none;
    }
    .btn-header:active { transform: translateY(2px); box-shadow: 0 0 0; }

    .container-custom { padding: 10px 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 10; flex: 1; width: 100%; box-sizing: border-box; }
    .card-box { background: var(--bg-card); border-radius: var(--radius-box); padding: 20px; margin-bottom: 16px; border: 2px solid #f1f5f9; box-shadow: var(--shadow-draw); }
    .form-label { display: block; font-weight: 700; color: var(--text-header); margin-bottom: 6px; font-size: 0.9rem; font-family: var(--font-hand); }
    .form-control, .form-select { width: 100%; background-color: #fff !important; border: 2px solid #cbd5e1 !important; color: var(--text-header) !important; padding: 10px 14px; border-radius: 16px; font-size: 1rem; font-weight: 600; height: 48px; box-shadow: inset 2px 2px 4px rgba(0,0,0,0.03); box-sizing: border-box; }
    .form-control:focus, .form-select:focus { outline: none; border-color: var(--primary) !important; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2) !important; }
    
    #amount { color: var(--primary) !important; font-size: 1.5rem; letter-spacing: 1px; font-family: var(--font-hand); transition: all 0.3s ease; }
    .input-negative { color: #ef4444 !important; font-weight: 900 !important; border-color: #ef4444 !important; background-color: #fef2f2 !important; }
    .status-label-negative { color: #ef4444; font-size: 0.8rem; font-weight: 700; margin-top: 4px; font-family: var(--font-hand); display: none; animation: fadeIn 0.2s ease; }

    .btn-action { background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; font-weight: 700; border-radius: 50px; padding: 14px; width: 100%; border: none; font-size: 1.1rem; font-family: var(--font-hand); box-shadow: 3px 3px 0 rgba(59, 130, 246, 0.25); margin-top: 10px; border: 2px solid #bfdbfe; transition: 0.1s; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-action:active { transform: translateY(3px); box-shadow: 0 0 0; }

    .switch-group { background: #f8fafc; padding: 10px 14px; border-radius: 16px; border: 2px solid #e2e8f0; box-shadow: 2px 2px 0 #e2e8f0; display: flex; align-items: center; justify-content: space-between; height: 100%; white-space: nowrap; cursor: pointer; transition: 0.2s; box-sizing: border-box; }
    .switch-label { display: flex; align-items: center; gap: 4px; font-weight: bold; }
    .form-check-input { width: 2.8em; height: 1.5em; background-color: #cbd5e1; border: 2px solid #cbd5e1; border-radius: 2em; cursor: pointer; pointer-events: none; appearance: none; position: relative; margin: 0; }
    .form-check-input::before { content: ""; position: absolute; width: 1.1em; height: 1.1em; border-radius: 50%; top: 0.1em; left: 0.1em; background-color: white; transition: 0.2s; }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }
    .form-check-input:checked::before { transform: translateX(1.3em); }

    #result-area { display: none; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .nccc-alert { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 12px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 16px; color: #b45309; }
    .result-tag { background: var(--primary); color: white; padding: 4px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; display: inline-block; font-family: var(--font-hand); box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(-1deg); }
    #fx-info { font-family: var(--font-hand); text-align: right; }

    .plan-card { padding: 16px; border-radius: 18px; margin-top: 12px; border: 2px solid #f1f5f9; position: relative; background: #fff; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .plan-winner { border-color: var(--primary); background: #f0f9ff; transform: rotate(-0.5deg); }
    /* âš ï¸ é˜²è­·ç‹€æ…‹ UI */
    .plan-warning { border-color: #fca5a5 !important; background: #fef2f2 !important; box-shadow: 2px 2px 0 #fecaca; }
    
    .winner-badge { position: absolute; top: -12px; right: 10px; background: #fde047; color: var(--text-header); font-size: 0.75rem; padding: 4px 12px; border-radius: 14px; font-weight: 700; border: 2px solid #fde047; box-shadow: 2px 2px 0 rgba(0,0,0,0.1); transform: rotate(3deg); font-family: var(--font-hand); }
    .card-name { font-size: 1.1rem; font-weight: 800; color: var(--text-header); margin: 0; }
    .card-miles { font-size: 1.3rem; color: #34d399; font-weight: 900; font-family: var(--font-hand); }
    .plan-warning .card-miles { color: #f87171; }
    
    .btn-card-action { border: 1px solid #e2e8f0; background: #fff; color: #64748b; border-radius: 50px; padding: 6px 14px; font-size: 0.8rem; font-weight: 700; font-family: var(--font-hand); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 4px; box-shadow: 1px 1px 0 #e2e8f0; }
    .btn-card-action.btn-record-win { background: #3b82f6; color: white; border-color: #2563eb; box-shadow: 1px 1px 0 #2563eb; }
    .btn-correct { border: 1px solid #e2e8f0; background: #fff; color: #94a3b8; border-radius: 50px; padding: 6px 12px; font-size: 0.8rem; font-weight: 700; font-family: var(--font-hand); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 4px; }
    .btn-correct:hover { background: #f1f5f9; color: var(--primary); border-color: var(--primary); }

    /* Warehouse Styles */
    .input-block-card { background: #fff; border: 2px solid #e2e8f0; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .input-block-title { font-family: var(--font-hand); font-weight: 700; color: #334155; margin-bottom: 12px; display: flex; align-items: center; font-size: 1rem; }
    .asset-item { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .airline-group-card { background: #fdfdfd; border: 2px solid #bfdbfe; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 0 rgba(191, 219, 254, 0.2); overflow: hidden; }
    .airline-header { background: #eff6ff; padding: 12px 16px; border-bottom: 2px solid #bfdbfe; display: flex; justify-content: space-between; align-items: center; }
    .airline-title { font-weight: 800; color: var(--primary-dark); font-size: 1.1rem; display: flex; align-items: center; }
    .airline-total { font-weight: 800; color: var(--text-header); font-size: 1.2rem; }
    .btn-asset-del { color: #cbd5e1; cursor: pointer; padding: 4px; background: none; border: none; }
    .btn-asset-del:hover { color: #ef4444; }

    .nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; border-top: 2px solid #e2e8f0; border-top-left-radius: 24px; border-top-right-radius: 24px; display: flex; justify-content: space-evenly; padding: 12px 0 25px 0; z-index: 1000; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
    .nav-item { color: var(--text-light); font-size: 0.7rem; font-weight: 700; cursor: pointer; padding: 6px; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; font-family: var(--font-hand); border-radius: 16px; flex: 1; border: none; background: none; }
    .nav-item .lucide { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active .lucide { transform: translateY(-3px); transition: 0.2s; stroke-width: 2.5; }
    .nav-badge { position: absolute; top: -5px; right: -8px; background: #ef4444; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; border: 2px solid #fff; line-height: 1; }

    .list-group-card { background: #fff; border: 2px solid #bfdbfe; border-radius: 18px; margin-bottom: 16px; overflow: hidden; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .list-group-header { background: #eff6ff; padding: 10px 16px; border-bottom: 2px solid #bfdbfe; font-weight: 800; color: var(--primary-dark); font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
    .list-item { padding: 12px 16px; border-bottom: 1px dashed #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
    .list-item:last-child { border-bottom: none; }
    .item-meta { font-size: 0.8rem; color: #64748b; font-weight: 600; display: flex; flex-direction: column; }
    .item-val { font-family: var(--font-hand); font-weight: 700; text-align: right; }
    .btn-item-del { color: #ef4444; background: #fee2e2; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; margin-left: 10px; border: 1px solid #fecaca; }

    .summary-card { background: white; border: 2px solid #e2e8f0; border-radius: 16px; margin-bottom: 8px; padding: 12px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; }
    .summary-name { font-weight: 800; color: #334155; font-size: 1rem; margin-bottom: 2px; }
    .summary-spend { font-size: 0.8rem; color: #64748b; font-weight: 600; }
    .summary-miles { font-weight: 800; color: var(--primary); font-family: var(--font-hand); font-size: 1.1rem; }
    
    .guide-slide { background: #fff; border-radius: 32px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 8px solid #fff; }
    .slide-sage { background-color: var(--m-sage); color: #fff; }
    .slide-dusty { background-color: var(--m-dusty); color: #fff; }
    .slide-clay { background-color: var(--m-clay); color: #5e503f; }
    .slide-slate { background-color: var(--m-slate); color: #fff; }
    .slide-stone { background-color: var(--m-stone); color: #fff; }
    .slide-terra { background-color: var(--m-terra); color: #fff; }
    .g-title { font-family: 'Noto Sans TC', sans-serif; font-weight: 900; font-size: 1.5rem; line-height: 1.3; margin-bottom: 1rem; }
    .g-text { font-family: 'Noto Sans TC', sans-serif; font-weight: 700; font-size: 0.95rem; line-height: 1.6; opacity: 0.95; }
    .g-badge { display: inline-block; background: rgba(255,255,255,0.3); padding: 4px 12px; border-radius: 50px; font-size: 0.7rem; font-weight: 900; margin-bottom: 10px; letter-spacing: 1px; }
    .g-list { padding-left: 0; }
    .g-list li { margin-bottom: 10px; list-style: none; position: relative; padding-left: 20px; font-size: 0.9rem; }
    .g-list li::before { content:'â€¢'; position:absolute; left:0; font-weight:bold; font-size: 1.2rem; line-height: 1; top: -2px; }

    /* =========================
       v12.6 è¦åŠƒå™¨å°ˆå±¬æ¨£å¼
       ========================= */
    .sub-tab-btn { color: #64748b; font-family: var(--font-hand); transition: 0.3s; border: none; font-size: 0.9rem; padding: 10px 0; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .sub-tab-btn.active { background: #ffffff; color: var(--primary-dark); box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 50px; }
    
    .planner-asset-card { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 16px; padding: 12px; margin-bottom: 10px; transition: 0.2s; cursor: pointer; }
    .planner-asset-card.selected { background: #eff6ff; border-color: var(--primary); border-style: solid; box-shadow: 2px 2px 0 #bfdbfe; }
    .planner-airline-logo { width: 30px; height: 30px; border-radius: 50%; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; }
    
    .planner-result-card { background: #fff; border: 2px solid #e2e8f0; border-radius: 20px; padding: 16px; margin-bottom: 12px; box-shadow: 2px 2px 0 rgba(0,0,0,0.03); }
    .planner-result-card.status-enough { border-color: #10b981; background: #ecfdf5; box-shadow: 2px 2px 0 #a7f3d0; }
    .planner-result-card.status-short { border-color: #f43f5e; background: #fff1f2; box-shadow: 2px 2px 0 #fecdd3; }
    
    .route-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 6px; margin-left: 6px; font-weight: bold; vertical-align: middle; white-space: nowrap; }
    .badge-direct { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
    .badge-transit { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
    
    .link-btn { display: inline-flex; align-items: center; justify-content: center; gap: 4px; font-size: 0.75rem; padding: 6px 12px; border-radius: 50px; font-weight: bold; background: white; border: 1px solid #cbd5e1; color: #475569 !important; transition: 0.2s; cursor: pointer; font-family: var(--font-hand); text-decoration: none !important; }
    .status-enough .link-btn { border-color: #10b981; color: #059669 !important; }
    .status-short .link-btn { border-color: #f43f5e; color: #e11d48 !important; }

    .swap-btn { background: white; border: 2px solid #e2e8f0; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: absolute; left: 50%; transform: translate(-50%, 8px); z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--primary); }

    /* ğŸ›¡ï¸ ç¥ç€è‰²åŠ ç²—è²æ˜å€ */
    .planner-disclaimer { 
      background: #fffbeb; border: 2px solid #f59e0b; border-radius: 18px; 
      padding: 14px 16px; margin-bottom: 16px; 
      color: #92400e; font-size: 0.85rem; line-height: 1.6;
      box-shadow: 3px 3px 0 #fef3c7;
    }
    .planner-disclaimer strong { font-weight: 900; color: #b45309; }

    /* =========================
       Modal çµ‚æ¥µé˜²å‘†ä¿®å¾© (è§£æ±ºæ•™å­¸è¢«å¡åˆ°å¤©èŠ±æ¿çš„å•é¡Œ)
       ========================= */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: none; overflow-x: hidden; overflow-y: auto; outline: 0; }
    .modal.show { display: block !important; } 
    .modal-dialog { margin: 2rem auto; max-width: 500px; border-radius: 24px; padding: 20px; position: relative; background: #fff; width: 90%; box-sizing: border-box; }
    
    /* æ•™å­¸å°ˆå±¬ Modal æ¨£å¼ */
    #guideModal .modal-dialog { background: transparent; padding: 0; box-shadow: none; margin-bottom: 4rem; }

    .btn-close { position: absolute; right: 15px; top: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; opacity: 0.5; padding: 0; }
    .custom-card-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
    
    .btn-outline-danger { color: #ef4444; border: 1px solid #ef4444; background: transparent; padding: 4px 8px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }
    .btn-outline-primary { color: var(--primary-dark); border: 2px solid var(--primary); background: transparent; padding: 6px 12px; border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-outline-secondary { color: #64748b; border: 2px solid #cbd5e1; background: #f8fafc; padding: 6px 12px; font-weight: bold; cursor: pointer; border-radius: 16px 0 0 16px; }
    .btn-light { background: #f1f5f9; border: none; color: #475569; padding: 10px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: var(--font-hand); }
    .btn-primary { background: var(--primary-dark); border: none; color: #fff; padding: 10px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-family: var(--font-hand); }
    
    .progress { display: flex; height: 6px; overflow: hidden; background-color: #e2e8f0; border-radius: 0.25rem; width: 100%; }
    .progress-bar { display: flex; flex-direction: column; justify-content: center; overflow: hidden; color: #fff; text-align: center; white-space: nowrap; background-color: #10b981; transition: width .6s ease; }
    .bg-warning { background-color: #f59e0b !important; } .bg-success { background-color: #10b981 !important; } .bg-danger { background-color: #ef4444 !important; }
    .fs-4 { font-size: 1.5rem !important; } .fs-5 { font-size: 1.25rem !important; } .fs-6 { font-size: 1rem !important; }
    .text-success { color: #10b981 !important; } .text-danger { color: #ef4444 !important; }
  </style>
</head>

<body>
  <!-- =========================
       å…§åµŒ SVG åœ–æ¨™åº«
       ========================= -->
  <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" style="display: none;">
    <symbol id="icon-plane" viewBox="0 0 24 24"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-.5-.5-2.5 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.2-1.1.6L3 8l6 4-3 3-3-1-2 2 4 4 2-2-1-3 3-3 4 6 1.2-.7c.4-.2.7-.6.6-1.1z"/></symbol>
    <symbol id="icon-book" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></symbol>
    <symbol id="icon-gear" viewBox="0 0 24 24"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></symbol>
    <symbol id="icon-cake" viewBox="0 0 24 24"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5-2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v3"/><path d="M12 8v3"/><path d="M17 8v3"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></symbol>
    <symbol id="icon-ticket" viewBox="0 0 24 24"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></symbol>
    <symbol id="icon-target" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></symbol>
    <symbol id="icon-bank" viewBox="0 0 24 24"><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 7 4 7"/></symbol>
    <symbol id="icon-calc" viewBox="0 0 24 24"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></symbol>
    <symbol id="icon-warn" viewBox="0 0 24 24"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></symbol>
    <symbol id="icon-list" viewBox="0 0 24 24"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></symbol>
    <symbol id="icon-shield" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></symbol>
    <symbol id="icon-rocket" viewBox="0 0 24 24"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"/><path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"/><path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5-2 5-2"/><path d="M12 15v5s3.03-.55 4-2c1.08-1.62 2-5 2-5"/></symbol>
    <symbol id="icon-rotate" viewBox="0 0 24 24"><path d="M8 3 4 7l4 4"/><path d="M4 7h16"/><path d="M16 21l4-4-4-4"/><path d="M20 17H4"/></symbol>
    <symbol id="icon-pen" viewBox="0 0 24 24"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></symbol>
    <symbol id="icon-warehouse" viewBox="0 0 24 24"><path d="M22 8.35V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8.35A2 2 0 0 1 3.26 6.5l8-3.2a2 2 0 0 1 1.48 0l8 3.2A2 2 0 0 1 22 8.35Z"/><path d="M6 18h12"/><path d="M6 14h12"/><rect width="12" height="12" x="6" y="10"/></symbol>
    <symbol id="icon-map" viewBox="0 0 24 24"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></symbol>
    <symbol id="icon-box" viewBox="0 0 24 24"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></symbol>
    <symbol id="icon-check-c" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></symbol>
    <symbol id="icon-check-sq" viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></symbol>
    <symbol id="icon-sq" viewBox="0 0 24 24"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></symbol>
    <symbol id="icon-info" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></symbol>
    <symbol id="icon-x" viewBox="0 0 24 24"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></symbol>
    <symbol id="icon-external" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></symbol>
    <symbol id="icon-swap" viewBox="0 0 24 24"><path d="m7 16 3 3 3-3"/><path d="M10 5v14"/><path d="m17 8-3-3-3 3"/><path d="M14 19V5"/></symbol>
  </svg>

  <!-- Header -->
  <div class="header">
    <div class="d-flex align-items-center">
      <div class="header-icon"><svg class="lucide"><use href="#icon-plane"/></svg></div>
      <div class="header-title">
        <h5>TDC èˆªç©ºç´¯å“©å·¥å…·<br>v12.6</h5>
        <small class="text-secondary fw-bold"><svg class="lucide me-1" style="font-size:0.8em;vertical-align:-0.1em;"><use href="#icon-gear"/></svg>å…¨çƒé›™å‘é˜²è­·æ——è‰¦ç‰ˆ</small>
      </div>
    </div>
    <div class="d-flex gap-2">
        <button class="btn-header text-primary" onclick="openGuide()"><svg class="lucide me-1"><use href="#icon-book"/></svg> æ•™å­¸</button>
        <button class="btn-header" onclick="openSettings()"><svg class="lucide"><use href="#icon-gear"/></svg></button>
    </div>
  </div>

  <div class="container-custom">
    
    <!-- Page 1: Calculator -->
    <div id="page-calc" class="page-section">
      <div class="card-box">
        <div class="row mb-3">
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('birthdayMode')" id="switch-box-birthdayMode" style="background:#fff1f2; border-color:#fecdd3; box-shadow: 2px 2px 0 #fecdd3;">
              <span class="switch-label text-danger"><svg class="lucide"><use href="#icon-cake"/></svg> ç”Ÿæ—¥æœˆ</span>
              <input class="form-check-input flex-shrink-0" type="checkbox" id="birthdayMode">
            </div>
          </div>
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('flyMode')" id="switch-box-flyMode" style="background:#ecfdf5; border-color:#a7f3d0; box-shadow: 2px 2px 0 #a7f3d0;">
              <span class="switch-label text-success"><svg class="lucide"><use href="#icon-ticket"/></svg> è¶Šé£›æœ‰å“©</span>
              <input class="form-check-input flex-shrink-0" type="checkbox" id="flyMode">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label text-primary d-flex align-items-center"><svg class="lucide me-1"><use href="#icon-target"/></svg> ç´¯ç©ç›®æ¨™</label>
          <select id="redemption-target" class="form-select border-primary" style="background-color: #eff6ff !important; border-width: 2px;">
            <option value="ALL">ğŸŒ ä¸æŒ‡å®š (æ‰€æœ‰èˆªå¸)</option>
            <option value="AM_BR">ğŸŒ äºè¬ / é•·æ¦® (AM / BR)</option>
            <option value="CI">ğŸŒ¸ ä¸­è¯èˆªç©º (CI)</option>
          </select>
        </div>

        <div class="row mb-1">
            <div class="col-5">
              <label class="form-label">å¹£åˆ¥</label>
              <select id="currency-type" class="form-select" onchange="toggleFxInput(this.value)">
                <option value="TWD">ğŸ‡¹ğŸ‡¼ å°å¹£</option>
                <option value="FOREIGN">ğŸŒ å¤–å¹£</option>
              </select>
            </div>
            <div class="col-7">
              <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
              <select id="payment" class="form-select">
                <option value="physical">ğŸ’³ å¯¦é«”å¡</option>
                <option value="online">ğŸŒ ç·šä¸Š/ç¶²è³¼</option>
                <option value="apple_pay">ğŸ Apple Pay</option>
                <option value="line_pay">ğŸŸ© LINE Pay</option>
              </select>
            </div>
        </div>

        <div id="fx-input-group" class="mt-2 mb-2 p-3" style="background: #f0f9ff; border: 2px dashed #bae6fd; border-radius: 16px; display: none;">
            <label class="form-label text-primary small">è«‹è¼¸å…¥ç•¶ä¸‹åŒ¯ç‡ (ç³»çµ±è‡ªå‹•åŠ è¨ˆ1.5%)</label>
            <div class="input-group mb-2">
                <span class="input-group-text bg-white" style="border: 2px solid #cbd5e1; border-right: none;">1 å¤–å¹£ = </span>
                <input type="number" id="fx-rate-input" class="form-control" placeholder="è¼¸å…¥åŒ¯ç‡" inputmode="decimal" min="0" step="0.0001">
                <span class="input-group-text bg-white" style="border: 2px solid #cbd5e1; border-left: none;">TWD</span>
            </div>
            <button onclick="window.open(atob('aHR0cHM6Ly9yYXRlLmJvdC5jb20udHcveHJ0P0xhbmc9emgtVFc='), '_blank')" class="btn-outline-primary w-100 mt-2 text-decoration-none" style="font-size:0.8rem; background:white; display:flex; align-items:center; justify-content:center;">
                <svg class="lucide me-1"><use href="#icon-bank"/></svg> æŸ¥è©¢è‡ºéŠ€ç‰Œå‘ŠåŒ¯ç‡
            </button>
        </div>

        <div class="mb-3 mt-3">
          <label class="form-label" id="amount-label">æ¶ˆè²»é‡‘é¡ (TWD)</label>
          <div class="input-group">
            <button class="btn-outline-secondary font-hand" type="button" onclick="toggleSign('amount')" style="font-size: 0.9rem;">é€€åˆ·/ä¿®æ­£</button>
            <input type="number" id="amount" class="form-control" placeholder="0" inputmode="decimal" oninput="checkInputStyle(this)">
          </div>
          <div id="amount-status" class="status-label-negative">âš ï¸ ä¿®æ­£/é€€åˆ·æ¨¡å¼ (æ²–å¸³)</div>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é¡åˆ¥ / å‚™è¨»</label>
          <select id="category" class="form-select mb-2" onchange="updateKeywordPlaceholder()">
            <option value="general">ğŸ›ï¸ ä¸€èˆ¬æ¶ˆè²»</option>
            <option value="dining">ğŸ½ï¸ é¤å»³/å¤–é€</option>
            <option value="travel">ğŸ¨ æ—…éŠ/è¨‚æˆ¿</option>
            <option value="flight_ci">ğŸŒ¸ è¯èˆªå®˜ç¶²</option>
            <option value="flight_cx">ğŸŒ² åœ‹æ³°å®˜ç¶²</option>
            <option value="flight_other">âœˆï¸ å…¶ä»–èˆªç©º</option>
          </select>
          <input type="text" id="keyword-input" class="form-control" placeholder="è¼¸å…¥åº—å®¶é—œéµå­— (å¦‚: éº¥ç•¶å‹, Agoda)..." style="font-size:0.9rem;">
        </div>

        <button onclick="calculate()" class="btn-action">é–‹å§‹è¨ˆç®— <svg class="lucide ms-2"><use href="#icon-calc"/></svg></button>
      </div>

      <div id="result-area">
        <div class="nccc-alert d-flex">
          <svg class="lucide me-2 mt-1 flex-shrink-0"><use href="#icon-warn"/></svg>
          <div>
            <div class="fw-bold mb-1">ç•™æ„å°é¡æ”¯ä»˜ç„¡å›é¥‹</div>
            é€£é–é€Ÿé£Ÿã€ä¾¿åˆ©å•†åº—ç­‰é€šè·¯ï¼Œæ¥µé«˜æ©Ÿç‡å±¬æ–¼ã€ŒNCCCå°é¡æ”¯ä»˜ã€ç„¡å›é¥‹ã€‚
          </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
          <span class="result-tag" id="scenario-tag">ä¸€èˆ¬æ¶ˆè²»</span>
          <div class="text-end lh-1" id="fx-info" style="display:none;"></div>
        </div>

        <div id="cards-container"></div>
      </div>
    </div>

    <!-- Page 2: Transaction List -->
    <div id="page-list" class="page-section" style="display:none;">
        <div class="d-flex justify-content-between align-items-end mb-3 px-1">
            <h5 class="text-primary mb-0 d-flex align-items-center"><svg class="lucide me-2"><use href="#icon-list"/></svg>å¾…çµç®—æ˜ç´°</h5>
            <span class="badge bg-secondary" id="pending-count" style="background:#64748b; color:white; padding:4px 8px; border-radius:12px; font-size:0.8rem;">0 ç­†</span>
        </div>
        <div id="transaction-list-container"></div>
        <div class="text-center mt-4">
            <p class="text-muted small">ç¢ºèªç„¡èª¤å¾Œï¼Œè«‹è‡³ã€Œç›£æ§ã€åˆ†é åŸ·è¡Œé€²å€‰ã€‚</p>
        </div>
    </div>

    <!-- Page 3: Status & Monitoring -->
    <div id="page-status" class="page-section" style="display:none;">
      <div class="card-box">
        <h5 class="mb-3 text-primary d-flex align-items-center"><svg class="lucide me-2"><use href="#icon-chart"/></svg>æœ¬æœŸç¸½å¸³ (Dashboard)</h5>
        <div id="status-container"></div>
        <div class="mt-3 d-flex gap-2">
           <button onclick="clearCurrentStats()" class="btn-outline-danger flex-grow-1 font-hand fw-bold bg-white" style="border-width:2px; padding:8px; border-radius:50px;">å…¨éƒ¨é‡ç½®</button>
           <button onclick="batchImport()" class="btn-action flex-grow-1 font-hand py-1 mt-0" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%); border:none; box-shadow:2px 2px 0 #047857;">ä¸€éµé€²å€‰</button>
        </div>
      </div>
      <div class="card-box mt-3" style="background:#fffbeb; border-color:#fde68a;">
        <h5 class="mb-3 text-warning d-flex align-items-center" style="color:#b45309;"><svg class="lucide me-2"><use href="#icon-shield"/></svg>ä¸Šé™å°ç®¡å®¶</h5>
        <div id="limits-container"></div>
      </div>
    </div>

    <!-- Page 4: Warehouse & Planner (v12.6 å…¨çƒé›™å‘çŸ©é™£ç‰ˆ) -->
    <div id="page-warehouse" class="page-section" style="display:none;">
        <div class="sub-tab-container mb-3 d-flex p-1" style="background: #e2e8f0; border-radius: 50px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
            <button class="flex-grow-1 fw-bold sub-tab-btn active" onclick="switchWarehouseTab('manage')" id="tab-btn-manage"><svg class="lucide me-1"><use href="#icon-box"/></svg> è³‡ç”¢ç®¡ç†</button>
            <button class="flex-grow-1 fw-bold sub-tab-btn" onclick="switchWarehouseTab('planner')" id="tab-btn-planner"><svg class="lucide me-1"><use href="#icon-map"/></svg> å…Œæ›è©¦ç®—</button>
        </div>

        <div id="warehouse-view-manage">
            <div class="input-block-card">
                <div class="input-block-title text-primary"><svg class="lucide me-2"><use href="#icon-plane"/></svg> å­˜å…¥èˆªç©ºå“©ç¨‹ (åŸç”Ÿ)</div>
                <div class="mb-3"><label class="form-label small mb-1 fw-bold">èˆªå¸åç¨±</label><input id="native-airline-name" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦®"></div>
                <div class="mb-3"><label class="form-label small mb-1 fw-bold">ç›®å‰æŒæœ‰å“©ç¨‹</label><input id="native-current" type="number" class="form-control" placeholder="0"></div>
                <button onclick="addNativeAsset()" class="btn-outline-primary w-100">å­˜å…¥èˆªç©ºå¸³æˆ¶</button>
            </div>
            
            <div class="input-block-card">
                <div class="input-block-title text-warning" style="color:#d97706;"><svg class="lucide me-2"><use href="#icon-rotate"/></svg> å­˜å…¥è½‰é»ç©åˆ† (é£¯åº—/éŠ€è¡Œ)</div>
                <div class="row mb-2">
                    <div class="col-7"><label class="form-label small mb-1 fw-bold">ç©åˆ†ä¾†æº</label><input id="trans-source-name" class="form-control" placeholder="å¦‚: è¬è±ª, å°æ¨¹é»"></div>
                    <div class="col-5"><label class="form-label small mb-1 fw-bold">æŒæœ‰ç©åˆ†</label><input id="trans-current" type="number" class="form-control" placeholder="0"></div>
                </div>
                <div class="mb-2"><label class="form-label small mb-1 fw-bold text-primary">æ¬²å…Œæ›ä¹‹ç›®æ¨™èˆªå¸ (æ­¸æˆ¶ä¾æ“š)</label><input id="trans-target-airline" class="form-control" placeholder="ä¾‹å¦‚: è¯èˆª, é•·æ¦® (è«‹ä¿æŒåç¨±ä¸€è‡´)"></div>
                <div class="bg-light p-2 rounded border mb-2">
                    <label class="small text-muted fw-bold mb-1">å…Œæ›å…¬å¼ (ä¾‹å¦‚: 360é» = 1000å“©)</label>
                    <div class="input-group input-group-sm mb-2">
                        <span class="input-group-text bg-white" style="border: 2px solid #cbd5e1; border-right: none;">æ¯</span>
                        <input id="trans-unit-points" type="number" class="form-control" placeholder="360" min="0">
                        <span class="input-group-text bg-white" style="border: 2px solid #cbd5e1; border-left: none; border-right: none;">é» = </span>
                        <input id="trans-unit-miles" type="number" class="form-control" placeholder="1000" min="0">
                        <span class="input-group-text bg-white" style="border: 2px solid #cbd5e1; border-left: none;">å“©</span>
                    </div>
                </div>
                <button onclick="addTransferAsset()" class="btn-outline-primary w-100" style="color:#b45309; border-color:#d97706;">å­˜å…¥è½‰é»è³‡ç”¢</button>
            </div>
            <div id="warehouse-list"></div>
        </div>

        <div id="warehouse-view-planner" style="display:none;">
            <!-- ğŸ›¡ï¸ ç¥ç€è‰²åŠ ç²—è²æ˜å€ -->
            <div class="planner-disclaimer">
              <div class="d-flex align-items-center mb-1">
                  <svg class="lucide me-1" style="color:#b45309;"><use href="#icon-warn"/></svg>
                  <strong style="font-size: 1rem;">å…¨çƒè¦åŠƒé‡è¦è²æ˜ (2026/2027)</strong>
              </div>
              <ul class="mb-0" style="padding-left: 1.2rem;">
                  <li><strong>å¯¦éš›ä½ç½®ç‹€æ…‹å„ªå…ˆ</strong>ï¼šé¡¯ç¤ºå€¼ç‚ºæ¨™æº–é ä¼°ï¼Œè«‹å‹™å¿…é»æ“Šç«‹å³å…Œæ›ä»¥å®˜ç¶²<strong>å¯¦éš›ä½ç½®ç‹€æ…‹</strong>ç‚ºæº–ã€‚</li>
                  <li><strong>åœ‹æ³°(CX)å‹•æ…‹åŒ–è­¦ç¤º</strong>ï¼šAsia Miles è‡ª 2025/04/15 èµ·ä¸å†å…¬ä½ˆè¡¨æ ¼ï¼Œæ•¸æ“šè¶¨å‘<strong>å‹•æ…‹å…Œæ›</strong>ï¼Œæ­¤è™•ç‚ºå¯¦æ¸¬åŸºæº–å€¼ã€‚</li>
                  <li><strong>æ•¸æ“šæ™‚æ•ˆæ€§</strong>ï¼šå…§å»ºä¹‹å…¨æ—¥ç©º(ANA)å­£ç¯€å¼•æ“èˆ‡å„å¤§èˆªå¸æ•¸æ“šé©ç”¨è‡³ <strong>2027 å¹´ 1 æœˆ</strong>ã€‚</li>
              </ul>
            </div>

            <div class="card-box" style="background: linear-gradient(to bottom, #eff6ff, #ffffff); position: relative;">
              <h5 class="mb-1 text-primary d-flex align-items-center"><svg class="lucide me-2"><use href="#icon-map"/></svg>è¨­å®šå…¨çƒå…Œæ›ç›®æ¨™</h5>
              
              <div class="mb-3 mt-3">
                <div style="position:relative;">
                  <label class="form-label small fw-bold">ğŸ›« å‡ºç™¼åœ°</label>
                  <select id="planner-from" class="form-select mb-2" onchange="runPlannerCalc()">
                    <option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                    <option value="HK_MO">ğŸ‡­ğŸ‡° æ¸¯æ¾³åœ°å€ (HK/MO)</option>
                    <option value="CN">ğŸ‡¨ğŸ‡³ ä¸­åœ‹å¤§é™¸ (CN)</option>
                    <option value="NE_ASIA">ğŸŒ¸ æ±åŒ—äº (æ—¥éŸ“)</option>
                    <option value="SE_ASIA">ğŸ¥¥ æ±å—äº</option>
                    <option value="NA_W">ğŸ—½ åŒ—ç¾è¥¿å²¸</option>
                    <option value="NA_E">ğŸ åŒ—ç¾æ±å²¸</option>
                    <option value="EU">ğŸ° æ­æ´²</option>
                  </select>
                  <button class="swap-btn" onclick="swapPlannerDest()"><svg class="lucide"><use href="#icon-swap"/></svg></button>
                  <label class="form-label small fw-bold">ğŸ›¬ ç›®çš„åœ°</label>
                  <select id="planner-to" class="form-select" onchange="runPlannerCalc()">
                    <option value="TW">ğŸ‡¹ğŸ‡¼ å°ç£</option>
                    <option value="HK_MO">ğŸ‡­ğŸ‡° æ¸¯æ¾³åœ°å€ (HK/MO)</option>
                    <option value="CN">ğŸ‡¨ğŸ‡³ ä¸­åœ‹å¤§é™¸ (CN)</option>
                    <option value="NE_ASIA" selected>ğŸŒ¸ æ±åŒ—äº (æ—¥éŸ“)</option>
                    <option value="SE_ASIA">ğŸ¥¥ æ±å—äº</option>
                    <option value="NA_W">ğŸ—½ åŒ—ç¾è¥¿å²¸</option>
                    <option value="NA_E">ğŸ åŒ—ç¾æ±å²¸</option>
                    <option value="EU">ğŸ° æ­æ´²</option>
                  </select>
                </div>
              </div>

              <div class="row mb-2">
                <div class="col-6">
                  <label class="form-label small fw-bold">ğŸ“… å‡ºç™¼æ—¥æœŸ</label>
                  <input type="date" id="planner-date" class="form-select" style="height:44px;" onchange="runPlannerCalc()">
                </div>
                <div class="col-6">
                  <label class="form-label small fw-bold">é¸æ“‡è‰™ç­‰</label>
                  <select id="planner-class" class="form-select" onchange="runPlannerCalc()">
                    <option value="Y">ğŸ’º ç¶“æ¿Ÿè‰™</option>
                    <option value="C">ğŸ¥‚ å•†å‹™è‰™</option>
                    <option value="F">ğŸ‘‘ é ­ç­‰è‰™</option>
                  </select>
                </div>
              </div>

              <div class="switch-group mb-2" onclick="togglePlannerTrip()">
                <span class="switch-label fw-bold"><svg class="lucide me-1"><use href="#icon-rotate"/></svg> è¡Œç¨‹ï¼š<span id="trip-label">ä¾†å› (Round-trip)</span></span>
                <input class="form-check-input" type="checkbox" id="planner-trip-type" checked>
              </div>

              <div class="small font-hand mt-2" style="color:#94a3b8;" id="planner-ana-hint">
                * ç³»çµ±å°‡ä¾æ—¥æœŸè‡ªå‹•åˆ¤å®š ANA æ·¡æ—ºå­£ (L/R/H)ã€‚
              </div>
            </div>

            <div class="mb-3 px-1">
                <h6 class="fw-bold text-secondary mb-2 d-flex align-items-center"><svg class="lucide me-1"><use href="#icon-box"/></svg>å‹¾é¸è¦å‹•ç”¨çš„å€‰åº«è³‡æº</h6>
                <div id="planner-asset-container"></div>
            </div>

            <div id="planner-results-container"></div>
        </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="nav-bottom">
    <button class="nav-item active" onclick="switchPage('calc', this)"><svg class="lucide"><use href="#icon-calc"/></svg>è¨ˆç®—</button>
    <button class="nav-item" onclick="switchPage('list', this)"><div style="position:relative;"><svg class="lucide"><use href="#icon-list"/></svg><div id="nav-badge-list" class="nav-badge" style="display:none;">0</div></div>æ˜ç´°</button>
    <button class="nav-item" onclick="switchPage('status', this)"><svg class="lucide"><use href="#icon-chart"/></svg>ç›£æ§</button>
    <button class="nav-item" onclick="switchPage('warehouse', this)"><svg class="lucide"><use href="#icon-warehouse"/></svg>å€‰åº«</button>
  </div>

  <!-- å®¢è£½åŒ–å®‰å…¨é˜²å‘† Modal ç³»çµ± -->
  <div class="modal fade" id="customConfirmModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content" style="background:#fff; border-radius:24px; padding:20px;">
        <div class="text-center d-flex flex-column align-items-center">
          <svg class="lucide text-warning mb-3" style="width:3rem;height:3rem;"><use href="#icon-warn"/></svg>
          <p class="mb-4 fw-bold text-secondary" id="confirm-msg" style="font-size: 1.05rem; line-height: 1.5;"></p>
          <div class="d-flex justify-content-center gap-2 w-100">
            <button type="button" class="btn-light flex-grow-1" onclick="hideModal('customConfirmModal')">å–æ¶ˆ</button>
            <button type="button" class="btn-primary flex-grow-1" id="confirm-btn-yes" style="background:#ef4444;">ç¢ºå®šåŸ·è¡Œ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="correctionModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content" style="background:#fff; border-radius:24px; padding:20px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0 d-flex align-items-center"><svg class="lucide me-2 text-primary"><use href="#icon-pen"/></svg>ä¿®æ­£å›é¥‹å€ç‡</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"><svg class="lucide"><use href="#icon-x"/></svg></button>
        </div>
        <div class="modal-body p-0">
          <p class="small text-muted mb-3">ä¿®æ­£ <strong><span id="modal-card-name"></span></strong> åœ¨é—œéµå­— <strong>ã€Œ<span id="modal-keyword"></span>ã€</strong> çš„å›é¥‹ã€‚</p>
          <div class="mb-3"><label class="form-label">è«‹è¼¸å…¥æ­£ç¢ºçš„ã€Œå¹¾å…ƒä¸€å“©ã€</label><input type="number" id="modal-new-rate" class="form-control text-center fw-bold text-primary" style="font-size:1.5rem;" placeholder="ä¾‹å¦‚: 18" min="0"><div class="text-center font-hand mt-1 small" style="color:#94a3b8;">è¼¸å…¥ 0 ä»£è¡¨ç„¡å›é¥‹</div></div>
          <button onclick="saveCorrection()" class="btn-primary w-100 font-hand">å„²å­˜ä¸¦é‡æ–°è¨ˆç®—</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="guideModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content" style="background:transparent; border:none; box-shadow:none; padding:0;">
        <div class="modal-body p-0" id="guide-content"></div>
        <div class="text-center mt-3 mb-4">
            <button class="btn-light rounded-circle" data-bs-dismiss="modal" style="width:50px; height:50px; padding:0; display:flex; align-items:center; justify-content:center; margin:0 auto; font-size:1.5rem; color:#475569; box-shadow:0 4px 10px rgba(0,0,0,0.1);"><svg class="lucide"><use href="#icon-x"/></svg></button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content" style="background:#fff; border-radius:24px; padding:20px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0 d-flex align-items-center"><svg class="lucide me-2 text-primary"><use href="#icon-gear"/></svg>è¨­å®šèˆ‡å¡ç‰‡ç®¡ç†</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"><svg class="lucide"><use href="#icon-x"/></svg></button>
        </div>
        <div class="modal-body p-0">
          <div class="mb-4"><div class="fw-bold mb-2 text-primary">åŠ ç¢¼è³‡æ ¼ç¢ºèª</div><div class="switch-group mb-2"><span class="switch-label">åŒ¯è± Live+ è‡ªå‹•æ‰£ç¹³ <small class="text-muted fw-normal">(ç²¾é¸+1%)</small></span><input class="form-check-input" type="checkbox" id="setting-hsbc-autopay" onchange="updateGlobalSetting('hsbc_autopay', this.checked)"></div></div>
          <div class="mb-4"><div class="fw-bold mb-2 text-primary">å…§å»ºç¥å¡</div><div id="builtin-cards-list"></div></div>
          <div class="mb-4"><div class="fw-bold mb-2 text-primary">è‡ªè¨‚å¡ç‰‡</div><div id="custom-cards-list" class="mb-3"></div><div class="p-3 border rounded-3" style="background:#fff; border-color:#bfdbfe !important; border-style:dashed !important;"><label class="small fw-bold text-primary mb-2 font-hand">ï¼‹ æ–°å¢å¡ç‰‡</label><input type="text" id="new-card-name" class="form-control mb-2" placeholder="å¡ç‰‡åç¨±"><div class="row mb-2"><div class="col-6"><input type="number" id="new-card-dom" class="form-control" placeholder="åœ‹å…§" min="0"></div><div class="col-6"><input type="number" id="new-card-for" class="form-control" placeholder="åœ‹å¤–" min="0"></div></div><button onclick="addCustomCard()" class="btn-primary w-100 mt-2 font-hand" style="padding:6px;">ç¢ºèªæ–°å¢</button></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="customAlertModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content" style="background:#fff; border-radius:24px; padding:30px 20px;">
        <div class="text-center d-flex flex-column align-items-center">
          <svg class="lucide text-warning mb-3" style="width:3rem;height:3rem;"><use href="#icon-warn"/></svg>
          <p class="mb-4 fw-bold text-secondary" id="alert-msg" style="font-size: 1.05rem; line-height: 1.5;"></p>
          <button type="button" class="btn-primary px-5 font-hand" data-bs-dismiss="modal">æˆ‘çŸ¥é“äº†</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editAssetModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-content" style="background:#fff; border-radius:24px; padding:20px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold m-0 d-flex align-items-center"><svg class="lucide me-2 text-primary"><use href="#icon-pen"/></svg>ä¿®æ”¹è³‡ç”¢é¤˜é¡</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"><svg class="lucide"><use href="#icon-x"/></svg></button>
        </div>
        <div class="modal-body p-0 text-center">
            <p class="small text-muted mb-2">æ­£åœ¨ä¿®æ”¹ï¼š<span id="edit-asset-name" class="fw-bold text-dark"></span></p>
            <input type="number" id="edit-asset-val" class="form-control text-center fw-bold text-primary mb-4" style="font-size:1.5rem;">
            <div class="d-flex justify-content-center gap-2">
                <button type="button" class="btn-light px-4" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn-primary px-4" onclick="saveAssetEdit()">å„²å­˜</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       TDC Miles Tool v12.6 å…¨çƒé˜²è­·æ——è‰¦ç‰ˆ (å…§å»ºæ™ºæ…§é¡åº¦é è­¦)
       ========================= */
    const DB_KEY = 'MILES_APP_V12_6_ISOLATED'; 
    const RULES_KEY = 'MILES_APP_RULES_V12_6';
    let correctionTarget = { id: null, name: null };
    let editAssetTargetIdx = null;
    let plannerSelectedAssets = new Set();
    let pendingConfirmCallback = null;

    // --- å…§å»ºé˜²ç¦¦èˆ‡å¡ç‰‡å®šç¾© ---
    const BUILTIN_DEFS = [
      { id: 'hsbc_live', name: 'åŒ¯è± Live+', default: true },
      { id: 'ctbc_ci_inf', name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨', default: false },
      { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',default: true },
      { id: 'hsbc_inf',  name: 'åŒ¯è± æ—…äººç„¡é™',default: true },
      { id: 'ctbc_ci',   name: 'ä¸­ä¿¡ è¯èˆªé¼å°Š', default: true }
    ];
    const AUTO_ASSETS = {
        'hsbc_live': { target: 'åŒ¯è± Live+ ç¾é‡‘ç©åˆ†', type: 'transfer', ratio: 2, unitPoints:1, unitMiles:2 },
        'hsbc_inf': { target: 'åŒ¯è± æ—…äººç©åˆ†', type: 'transfer', ratio: 1, unitPoints:1, unitMiles:1 },
        'ctbc_ci': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'ctbc_ci_inf': { target: 'ä¸­è¯èˆªç©º (å“©ç¨‹)', type: 'airline', ratio: 1 },
        'taishin_cx': { target: 'äºæ´²è¬é‡Œé€š/åœ‹æ³° (å“©ç¨‹)', type: 'airline', ratio: 1 }
    };
    
    const DEFAULT_BILLING = { hsbc:6, ctbc:15, taishin:20, other:1 };
    const LIVE_KEYWORDS = { 'dining':['é¤å»³','åƒé£¯','å¤–é€','ubereats','foodpanda','ç‡’è‚‰','ç«é‹','éº»è¾£','å£½å¸','æ—¥å¼','å±…é…’å±‹','é¤é…’é¤¨','é…’å§','å’–å•¡','ç”œé»','ç‰›æ’','éµæ¿ç‡’','æ‹‰éºµ','èŒ¶å…­','å±‹é¦¬','ä¹¾æ¯','buffet','ç‹å“','äº«é´¨','å¤æ…•å°¼','è¥¿å ¤','çŸ³äºŒé‹','é™¶æ¿å±‹','é’èŠ±é©•','é¥—è³“','é¥—é¥—','é–‹é£¯','ç“¦åŸ','é¼æ³°è±','æµ·åº•æ’ˆ','é‡‘å¤§é‹¤','ç¯‰é–“','å£½å¸éƒ','è—å£½å¸','çˆ­é®®','å‰å…†','æ˜å£½å¸','é‡‘è‰²ä¸‰éº¥','æ˜¥å¤§ç›´','è²³æ¨“','æ¶“è±†è…','hooters','å‹ç”°','éº¥ç•¶å‹','æ˜Ÿå·´å…‹','å¿…å‹å®¢','é”ç¾æ¨‚','å¯Œç‹','æ–‡å…¬é¤¨','æ•™çˆ¶ç‰›æ’','å±±æµ·æ¨“','é¹½ä¹‹è¯','ç‰¡ä¸¹','logy','inita','ikea','è«å‡¡å½¼','è²´æ—ä¸–å®¶'], 'shop':['momo','pchome','è¦çš®','shopee','amazon','ebay','éœ²å¤©','friday','gomaji','æ·˜å¯¶','uniqlo','zara','h&m','net','gu','nike','adidas','outlet','å°åŒ—101','ä¸‰äº•','å¾®é¢¨','sogo','æ¼¢ç¥','è¯æ³°','æ–°å…‰','skm','att','ç¾éº—è¯','å—ç´¡','çµ±ä¸€æ™‚ä»£','é é›„','äº¬ç«™','citylink','å¤¢æ™‚ä»£','lalaport','é«˜å³¶å±‹','ä¸­å‹','é ä¼','éº—å¯¶','æ¯”æ¼¾','å¤§æ±Ÿ','å·¨åŸ','é æ±','global mall','ç’°çƒ','ç¾©å¤§','å°èŒ‚','å®åŒ¯','ç¾©äº«','noke','å¤§é­¯é–£','æ˜æ›œ','bellavita','å¯¶é›…','ç„¡å°è‰¯å“','muji','å±ˆè‡£æ°','åº·æ˜¯ç¾','æ¾æœ¬æ¸…','å”å‰è¨¶å¾·'], 'entertainment':['æ–°å…‰å½±åŸ','å¨ç§€','åœ‹è³“','ç§€æ³°','ç’°çƒå½±åŸ','è¿ªå£«å°¼','å‰åœåŠ›','æ¨‚å¤©ä¸–ç•Œ','legoland','safari','å…’ç«¥æ–°æ¨‚åœ’','x park','å°äººåœ‹','å…­ç¦æ‘','æµ·æ´‹å…¬åœ’','éº—å¯¶æ¨‚åœ’','åŠæ¹–å±±','ä¹æ—','å°šé †','ç¾©å¤§éŠæ¨‚','å·§è™','å‹•ç‰©åœ’','æµ·ç”Ÿé¤¨','å¥‡ç¾åšç‰©é¤¨','å°å®å™¹','é‡æŸ³','åŸ”å¿ƒ','é£›ç‰›','é ‘çš®ä¸–ç•Œ','ç¾è¡“é¤¨','æ—¥æœˆæ½­','å¤ªå¹³å±±','é˜¿é‡Œå±±','å¤§é›ªå±±','å¢¾ä¸','æ£®æ—éŠæ¨‚å€'] };
    
    const STRICT_ONLINE = ['flight_ci','flight_cx','flight_other']; 
    const CTBC_BLOCK = ['å…¨è¯','px','å…¨æ”¯ä»˜','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','etoro','wise','revolut','éº¥ç•¶å‹','è‚¯å¾·åŸº','æ¼¢å ¡ç‹','æ‘©æ–¯'];
    const HSBC_BLOCK_BASE = ['å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åˆ¤æ±ºæ›¸','é†«ç™‚','æ›è™Ÿ','å¹´è²»','æ‰‹çºŒè²»','è³­åš','éº¥ç•¶å‹','è‚¯å¾·åŸº'];
    const HSBC_LIVE_BLOCK = ['å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åˆ¤æ±ºæ›¸','é†«ç™‚','æ›è™Ÿ','å¹´è²»','æ‰‹çºŒè²»','è³­åš'];
    const TAISHIN_BLOCK = ['åˆ†æœŸ','å…¨è¯','px','7-11','711','å…¨å®¶','èŠçˆ¾å¯Œ','okè¶…å•†','ç¹³è²»','åœ‹æ°‘å¹´é‡‘','etag','ä¸‰å•†ç¾é‚¦','éº¥ç•¶å‹','è‚¯å¾·åŸº'];

    // ğŸ›¡ï¸ æ™ºæ…§é¡åº¦é˜²è­·ç³»çµ±ï¼šå–å¾—æ­£ç¢ºçš„ç›£æ§é‡‘é‘° (ä¸­ä¿¡/å°æ–°ç‚ºæ›†å¹´åˆ¶)
    function getLimitKey(db, id, dateObj) {
        if(['taishin_cx', 'ctbc_ci', 'ctbc_ci_inf'].includes(id)) return `${dateObj.getFullYear()}-${id}`;
        let day = db.settings.billingDays[id.split('_')[0]] || 1;
        const offset = dateObj.getDate() > day ? 1 : 0;
        const d = new Date(dateObj.getFullYear(), dateObj.getMonth() + offset, 1);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${id}`;
    }

    // ğŸ† è¨ˆç®—å¼•æ“æ ¸å¿ƒ (å°å…¥å‹•æ…‹æ‹†å¸³èˆ‡é è­¦)
    const CARD_RULES = {
        'ctbc_ci_inf': { 
            name: 'ä¸­ä¿¡ è¯èˆªç’€ç’¨', 
            calc: (ctx) => { 
                if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger">ğŸš« éå›é¥‹é …ç›®</span>', consumedQuota:0 }; 
                const isOnline = STRICT_ONLINE.includes(ctx.cat) || ctx.pay === 'online'; 
                const isTruePhysical = !isOnline && (ctx.pay === 'physical' || ctx.pay === 'apple_pay'); 
                let div = 20, isBonus = false; 
                
                if (ctx.isBirthday && ctx.isForeign && isTruePhysical) { div = 6.6; isBonus = true; } 
                else if (ctx.cat.startsWith('flight') || ctx.isForeign || ['agoda','booking','trip'].some(w=>ctx.kwKey.includes(w))) { div = 10; isBonus = true; } 

                if (isBonus) {
                    let limit = 600000;
                    let used = ctx.db.limits[`${new Date().getFullYear()}-ctbc_ci_inf`] ? ctx.db.limits[`${new Date().getFullYear()}-ctbc_ci_inf`].spend : 0;
                    let remaining = Math.max(0, limit - used);
                    
                    if (ctx.twdBase <= remaining) {
                        return { miles: Math.trunc(ctx.twdBase / div), note: (div===6.6 ? 'ğŸ‚ ç”Ÿæ—¥æµ·å¤–å¯¦é«” $6.6' : 'âœˆï¸ æŒ‡å®š/æµ·å¤– $10'), consumedQuota: ctx.twdBase };
                    } else {
                        let bonusMiles = Math.trunc(remaining / div);
                        let baseMiles = Math.trunc((ctx.twdBase - remaining) / 20);
                        let note = remaining === 0 ? `<span class="text-danger fw-bold">ğŸš« å¹´åº¦åŠ ç¢¼é¡åº¦å·²æ»¿</span><br><small class="text-danger">é™å› 20å…ƒ/å“©ï¼Œä¾å¯¦éš›ä½ç½®ç‹€æ…‹ç‚ºæº–</small>` : `<span class="text-danger fw-bold">âš ï¸ éƒ¨åˆ†è¶…é¡ (å‰© $${remaining.toLocaleString()})</span><br><small class="text-danger">è§¸åŠä¸Šé™é™å› 20å…ƒ/å“©ï¼Œä¾å¯¦éš›ä½ç½®ç‹€æ…‹ç‚ºæº–</small>`;
                        return { miles: bonusMiles + baseMiles, note: note, consumedQuota: remaining, isWarning: true };
                    }
                }
                return { miles: Math.trunc(ctx.twdBase / 20), note: 'ä¸€èˆ¬æ¶ˆè²» $20', consumedQuota: 0 }; 
            } 
        },
        'hsbc_live': { 
            name: 'åŒ¯è± Live+', 
            calc: (ctx) => { 
                if (ctx.isEUR) return { miles:0, note: '<span class="text-danger">ğŸš« æ­ç›Ÿå¯¦é«”ä¸å›é¥‹</span>', consumedQuota:0 }; 
                if (HSBC_LIVE_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note: '<span class="text-danger">ğŸš« éå›é¥‹é …ç›®</span>', consumedQuota:0 }; 
                if (['apple_pay','line_pay'].includes(ctx.pay)) return { miles:0, note: 'ğŸš« ç¶å®šè¡Œå‹•æ”¯ä»˜ç„¡åŠ ç¢¼', consumedQuota:0 }; 
                let displayType = 'ä¸€èˆ¬', bonus = 0, isAsian = ['JPY','KRW','SGD','THB','CNY'].includes(ctx.curr); 
                let base = ctx.twdBase * 0.0088; 
                if(ctx.isLiveSelect) { 
                    displayType = 'ç²¾é¸'; bonus += ctx.twdBase * 0.03; if(bonus>888) bonus=888; 
                    if(ctx.db.settings.hsbc_autopay) { let b2 = ctx.twdBase * 0.01; if(b2>200) b2=200; bonus+=b2; } 
                    if(isAsian) { let b2 = ctx.twdBase * 0.01; if(b2>200) b2=200; bonus+=b2; displayType='äºæ´²ç²¾é¸'; } 
                } else if(ctx.db.settings.hsbc_autopay) { 
                    displayType='ä¸€èˆ¬+ä»»å‹™'; base += ctx.twdBase * 0.01; 
                } 
                return { miles: Math.trunc(base + bonus) * 2, note: `${displayType} <small>1é»=2å“©</small>`, consumedQuota: ctx.twdBase }; 
            } 
        },
        'taishin_cx': { 
            name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ', 
            calc: (ctx) => { 
                if (TAISHIN_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'<span class="text-danger">ğŸš« éå›é¥‹é …ç›®</span>', consumedQuota:0 }; 
                let baseDiv = ctx.isForeign ? 15 : 22; 
                let isMobilePay = (ctx.pay === 'apple_pay' || ctx.pay === 'line_pay'); 
                let isBonus = false;

                if (ctx.cat === 'flight_cx' && !isMobilePay && !ctx.isForeign) { isBonus = true; }
                else if (ctx.isFlyMode && ctx.cat !== 'flight_ci' && !isMobilePay && (['agoda','booking','klook'].some(w=>ctx.kwKey.includes(w)) || (ctx.isForeign && ctx.pay==='physical'))) { isBonus = true; }

                if (isBonus) {
                    let limit = 1000000;
                    let used = ctx.db.limits[`${new Date().getFullYear()}-taishin_cx`] ? ctx.db.limits[`${new Date().getFullYear()}-taishin_cx`].spend : 0;
                    let remaining = Math.max(0, limit - used);

                    if (ctx.twdBase <= remaining) {
                        return { miles: Math.trunc(ctx.twdBase / 5), note: 'è¶Šé£›æœ‰å“© $5', consumedQuota: ctx.twdBase };
                    } else {
                        let bonusMiles = Math.trunc(remaining / 5);
                        let baseMiles = Math.trunc((ctx.twdBase - remaining) / baseDiv);
                        let note = remaining === 0 ? `<span class="text-danger fw-bold">ğŸš« è¶Šé£›åŠ ç¢¼é¡åº¦å·²æ»¿</span><br><small class="text-danger">é™å› ${baseDiv}å…ƒ/å“©ï¼Œä¾å¯¦éš›ä½ç½®ç‹€æ…‹ç‚ºæº–</small>` : `<span class="text-danger fw-bold">âš ï¸ éƒ¨åˆ†è¶…é¡ (å‰© $${remaining.toLocaleString()})</span><br><small class="text-danger">è§¸åŠä¸Šé™é™å› ${baseDiv}å…ƒ/å“©ï¼Œä¾å¯¦éš›ä½ç½®ç‹€æ…‹ç‚ºæº–</small>`;
                        return { miles: bonusMiles + baseMiles, note: note, consumedQuota: remaining, isWarning: true };
                    }
                }
                return { miles: Math.trunc(ctx.twdBase / baseDiv), note: (ctx.isForeign?'æµ·å¤– $15':'åœ‹å…§ $22'), consumedQuota: 0 }; 
            } 
        },
        'hsbc_inf': { 
            name: 'åŒ¯è± æ—…äººç„¡é™', 
            calc: (ctx) => { 
                if (['éº¥ç•¶å‹', ...HSBC_BLOCK_BASE].some(w => ctx.kwKey.includes(w))) return { miles:0, note:'ğŸš« éå›é¥‹', consumedQuota:0 }; 
                let div = (ctx.cat.startsWith('flight') || ctx.isForeign) ? 10 : 18; 
                return { miles: Math.trunc(ctx.twdBase/div), note: `$${div}å…ƒ/å“©`, consumedQuota: ctx.twdBase }; 
            } 
        },
        'ctbc_ci': { 
            name: 'ä¸­ä¿¡ è¯èˆªé¼å°Š', 
            calc: (ctx) => { 
                if (CTBC_BLOCK.some(w => ctx.kwKey.includes(w))) return { miles:0, note:'ğŸš« éå›é¥‹', consumedQuota:0 }; 
                const isOnline = STRICT_ONLINE.includes(ctx.cat) || ctx.pay === 'online'; 
                const isTruePhysical = !isOnline && (ctx.pay === 'physical' || ctx.pay === 'apple_pay'); 
                let isBonus = false, div = 18, noteBase = ''; 

                if(ctx.cat === 'flight_ci') { div=9; isBonus=true; noteBase='è¯èˆªå®˜ç¶² $9'; } 
                else if(ctx.isForeign && isTruePhysical) { 
                    if(ctx.isBirthday) { div=6; isBonus=true; noteBase='ğŸ‚ ç”Ÿæ—¥å¯¦é«” $6'; } 
                    else { div=9; isBonus=true; noteBase='æµ·å¤–å¯¦é«” $9'; } 
                } 

                if (isBonus) {
                    let limit = 1440000;
                    let used = ctx.db.limits[`${new Date().getFullYear()}-ctbc_ci`] ? ctx.db.limits[`${new Date().getFullYear()}-ctbc_ci`].spend : 0;
                    let remaining = Math.max(0, limit - used);

                    if (ctx.twdBase <= remaining) {
                        return { miles: Math.trunc(ctx.twdBase / div), note: noteBase, consumedQuota: ctx.twdBase };
                    } else {
                        let bonusMiles = Math.trunc(remaining / div);
                        let baseMiles = Math.trunc((ctx.twdBase - remaining) / 18);
                        let note = remaining === 0 ? `<span class="text-danger fw-bold">ğŸš« å¹´åº¦åŠ ç¢¼é¡åº¦å·²æ»¿</span><br><small class="text-danger">é™å› 18å…ƒ/å“©ï¼Œä¾å¯¦éš›ä½ç½®ç‹€æ…‹ç‚ºæº–</small>` : `<span class="text-danger fw-bold">âš ï¸ éƒ¨åˆ†è¶…é¡ (å‰© $${remaining.toLocaleString()})</span><br><small class="text-danger">è§¸åŠä¸Šé™é™å› 18å…ƒ/å“©ï¼Œä¾å¯¦éš›ä½ç½®ç‹€æ…‹ç‚ºæº–</small>`;
                        return { miles: bonusMiles + baseMiles, note: note, consumedQuota: remaining, isWarning: true };
                    }
                }
                return { miles: Math.trunc(ctx.twdBase/18), note: (ctx.isForeign?'æµ·å¤–ç¶²è³¼ $18':'ä¸€èˆ¬æ¶ˆè²» $18'), consumedQuota: 0 }; 
            } 
        }
    };

    // --- å…¨å‘çŸ©é™£èˆ‡ Base64 é˜²ç¦¦ç¶² (2026 æœ€æ–°å®˜æ–¹æ ¡æº–ç‰ˆ) ---
    const b64_CI = 'aHR0cHM6Ly93d3cuY2hpbmEtYWlybGluZXMuY29tL3R3L3poL21lbWJlci9yZWRlZW0tYWlybGluZS1taWxlcy9yZXdhcmQtdGlja2V0';
    const b64_BR = 'aHR0cHM6Ly93d3cuZXZhYWlyLmNvbS96aC10dy9pbmZpbml0eS1taWxlYWdlbGFuZHMvbWlsZWFnZS1hd2FyZC1wcm9ncmFtL21pbGVhZ2UtcmVkZW1wdGlvbi9hd2FyZC10aWNrZXQvZXZhLXVuaS1haXIv';
    const b64_CX = 'aHR0cHM6Ly93d3cuY2F0aGF5cGFjaWZpYy5jb20vY3gvemhfVFcuaHRtbA==';
    const b64_ANA = 'aHR0cHM6Ly93d3cuYW5hLmNvLmpwL3poL3R3L2FtYy9pbnRlcm5hdGlvbmFsLWZsaWdodC1hd2FyZHMv';

    const MATRIX_DATA = {
        'TW_HK_MO': { CI: { Y: 20000, C: 50000 }, BR: { Y: 20000, C: 50000 }, CX: { Y: 14000, C: 32000 }, NH: { Y: 20000, C: 40000 } },
        'TW_CN': { CI: { Y: 35000, C: 60000 }, BR: { Y: 35000, C: 50000 }, CX: { Y: 20000, C: 56000 }, NH: { Y: 20000, C: 40000 } },
        'TW_NE_ASIA': { CI: { Y: 35000, C: 60000 }, BR: { Y: 35000, C: 50000 }, CX: { Y: 20000, C: 56000, F: 86000 }, NH: { Y: {L:17000, R:20000, H:23000}, C: 48000 } },
        'TW_SE_ASIA': { CI: { Y: 35000, C: 60000 }, BR: { Y: 35000, C: 50000 }, CX: { Y: 20000, C: 56000, F: 86000 }, NH: { Y: {L:30000, R:35000, H:38000}, C: 60000 } },
        'TW_NA_W': { CI: { Y: 110000, C: 160000 }, BR: { Y: 100000, C: 150000 }, CX: { Y: 84000, C: 230000, F: 330000 }, NH: { Y: {L:90000, R:110000, H:120000}, C: 108000, F: 165000 } },
        'TW_NA_E': { CI: { Y: 110000, C: 160000 }, BR: { Y: 100000, C: 150000 }, CX: { Y: 84000, C: 230000, F: 330000 }, NH: { Y: {L:90000, R:110000, H:120000}, C: 108000, F: 165000 } },
        'TW_EU': { CI: { Y: 110000, C: 160000 }, BR: { Y: 100000, C: 150000 }, CX: { Y: 84000, C: 230000, F: 330000 }, NH: { Y: {L:110000, R:120000, H:130000}, C: 119000, F: 180000 } },
        'HK_MO_CN': { CI: { Y: 35000, C: 60000 }, BR: { Y: 35000, C: 50000 }, CX: { Y: 20000, C: 56000 }, NH: { Y: 20000, C: 40000 } },
        'HK_MO_NE_ASIA': { CI:{Y:35000, C:60000}, BR:{Y:35000, C:50000}, CX:{Y:20000, C:56000, F:86000}, NH:{Y:{L:17000,R:20000,H:23000}, C:48000} },
        'HK_MO_SE_ASIA': { CI:{Y:35000, C:60000}, BR:{Y:35000, C:50000}, CX:{Y:20000, C:56000, F:86000}, NH:{Y:{L:30000,R:35000,H:38000}, C:60000} },
        'HK_MO_NA_W': { CI:{Y:110000, C:160000}, BR:{Y:100000, C:150000}, CX:{Y:84000, C:230000}, NH:{Y:{L:90000,R:110000,H:120000}, C:108000} },
        'HK_MO_NA_E': { CI:{Y:110000, C:160000}, BR:{Y:100000, C:150000}, CX:{Y:84000, C:230000}, NH:{Y:{L:90000,R:110000,H:120000}, C:108000} },
        'HK_MO_EU': { CI:{Y:110000, C:160000}, BR:{Y:100000, C:150000}, CX:{Y:54000, C:176000}, NH:{Y:{L:110000,R:120000,H:130000}, C:119000} },
        'CN_NE_ASIA': { CI:{Y:35000, C:60000}, BR:{Y:35000, C:50000}, CX:{Y:20000, C:56000, F:86000}, NH:{Y:{L:17000,R:20000,H:23000}, C:48000} },
        'CN_SE_ASIA': { CI:{Y:35000, C:60000}, BR:{Y:35000, C:50000}, CX:{Y:20000, C:56000, F:86000}, NH:{Y:{L:30000,R:35000,H:38000}, C:60000} },
        'CN_NA_W': { CI:{Y:110000, C:160000}, BR:{Y:100000, C:150000}, CX:{Y:84000, C:230000}, NH:{Y:{L:90000,R:110000,H:120000}, C:108000} },
        'CN_NA_E': { CI:{Y:110000, C:160000}, BR:{Y:100000, C:150000}, CX:{Y:84000, C:230000}, NH:{Y:{L:90000,R:110000,H:120000}, C:108000} },
        'CN_EU': { CI:{Y:110000, C:160000}, BR:{Y:100000, C:150000}, CX:{Y:54000, C:176000}, NH:{Y:{L:110000,R:120000,H:130000}, C:119000} },
        'NE_ASIA_NA_W': { NH:{Y:{L:40000,R:50000,H:55000}, C:{L:75000,R:85000,H:90000}, F:150000} },
        'NE_ASIA_NA_E': { NH:{Y:{L:40000,R:50000,H:55000}, C:{L:75000,R:85000,H:90000}, F:150000} },
        'NE_ASIA_EU': { NH:{Y:{L:45000,R:55000,H:60000}, C:{L:85000,R:90000,H:95000}, F:165000} },
        'SE_ASIA_NA_W': { NH:{Y:{L:55000,R:65000,H:70000}, C:{L:100000,R:110000,H:115000}} },
        'SE_ASIA_NA_E': { NH:{Y:{L:55000,R:65000,H:70000}, C:{L:100000,R:110000,H:115000}} },
        'SE_ASIA_EU': { NH:{Y:{L:65000,R:70000,H:75000}, C:{L:110000,R:115000,H:120000}} }
    };

    function loadDB() {
        const raw = localStorage.getItem(DB_KEY);
        if(!raw) return { settings: { enabledBuiltins: ['hsbc_live','taishin_cx','ctbc_ci','hsbc_inf','ctbc_ci_inf'], billingDays: { ...DEFAULT_BILLING }, hsbc_autopay: true }, customCards: [], records: {}, limits: {}, warehouse: [] };
        const db = JSON.parse(raw);
        if(!db.records) db.records = {}; 
        if(!db.warehouse) db.warehouse = [];
        return db;
    }
    function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function loadRules() { const raw = localStorage.getItem(RULES_KEY); return raw ? JSON.parse(raw) : {}; }
    function saveRules(data) { localStorage.setItem(RULES_KEY, JSON.stringify(data)); }

    function autoFixMissingCards() {
        const db = loadDB(); let modified = false;
        if (!db.settings.enabledBuiltins.includes('hsbc_inf')) { db.settings.enabledBuiltins.push('hsbc_inf'); modified = true; }
        if (modified) saveDB(db);
    }

    function toggleFxInput(val) {
        const fxGroup = document.getElementById('fx-input-group'); const amountLabel = document.getElementById('amount-label'); const amountInput = document.getElementById('amount');
        if (val === 'FOREIGN') { fxGroup.style.display = 'block'; amountLabel.innerText = 'æ¶ˆè²»é‡‘é¡ (å¤–å¹£)'; amountInput.placeholder = 'è¼¸å…¥å¤–å¹£é‡‘é¡'; } 
        else { fxGroup.style.display = 'none'; amountLabel.innerText = 'æ¶ˆè²»é‡‘é¡ (TWD)'; amountInput.placeholder = 'è¼¸å…¥å°å¹£é‡‘é¡'; }
    }

    function toggleSign(id) {
        const el = document.getElementById(id); let val = parseFloat(el.value);
        if(isNaN(val)) val = 0; el.value = val * -1; checkInputStyle(el);
    }
    
    function toggleSwitch(id) { const cb = document.getElementById(id); cb.checked = !cb.checked; }

    function checkInputStyle(el) {
        const val = parseFloat(el.value); const statusEl = document.getElementById(el.id + '-status');
        if(val < 0) { el.classList.add('input-negative'); if(statusEl) statusEl.style.display = 'block'; } 
        else { el.classList.remove('input-negative'); if(statusEl) statusEl.style.display = 'none'; }
    }

    let currentResults = [];
    function calculate() {
        const db = loadDB(); const rules = loadRules(); const amt = parseFloat(document.getElementById('amount').value);
        if(isNaN(amt) || amt === 0) return showAlert('è«‹è¼¸å…¥é‡‘é¡ï¼');
        
        const currType = document.getElementById('currency-type').value;
        let twdBase = amt; let twdSpend = amt; let rate = 1;

        if (currType === 'FOREIGN') {
            const rateInput = document.getElementById('fx-rate-input').value;
            if(!rateInput) return showAlert('è«‹è¼¸å…¥å¤–å¹£åŒ¯ç‡ï¼');
            rate = parseFloat(rateInput); twdBase = Math.round(amt * rate); twdSpend = Math.round(twdBase * 1.015);
        }

        const ctx = {
            db: db, curr: currType==='FOREIGN'?'USD':'TWD', cat: document.getElementById('category').value,
            pay: document.getElementById('payment').value, kwKey: (document.getElementById('keyword-input').value || '').trim().toLowerCase(),
            isBirthday: document.getElementById('birthdayMode').checked, isFlyMode: document.getElementById('flyMode').checked,
            isForeign: currType === 'FOREIGN', isEUR: false, twdBase: twdBase, twdSpend: twdSpend, isLiveSelect: false
        };

        if(ctx.cat === 'dining') ctx.isLiveSelect = true;
        else if(LIVE_KEYWORDS['dining'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['shop'].some(w => ctx.kwKey.includes(w)) || LIVE_KEYWORDS['entertainment'].some(w => ctx.kwKey.includes(w))) ctx.isLiveSelect = true;
        if(ctx.kwKey.includes('éº¥ç•¶å‹')) ctx.isLiveSelect = true; 

        const fxInfo = document.getElementById('fx-info'); const scenarioTag = document.getElementById('scenario-tag');
        if(ctx.isForeign) {
            scenarioTag.innerText = 'å¤–å¹£æ¶ˆè²»'; fxInfo.style.display = 'block';
            fxInfo.innerHTML = `<div class="small text-muted">æŠ˜åˆå°å¹£ $${twdBase.toLocaleString()}</div><div class="fw-bold text-dark">æˆæœ¬ $${twdSpend.toLocaleString()} <small class="text-secondary">(å«1.5%)</small></div>`;
        } else { scenarioTag.innerText = 'ä¸€èˆ¬æ¶ˆè²»'; fxInfo.style.display = 'none'; }

        currentResults = [];
        const resolveMiles = (cardId, defCalc) => {
            const ruleKey = `${ctx.kwKey}|${cardId}`;
            if(ctx.kwKey && rules[ruleKey] !== undefined) {
                const customDiv = rules[ruleKey];
                return customDiv===0 ? { miles:0, note:'âš™ï¸ è‡ªè¨‚: ç„¡å›é¥‹', consumedQuota:0 } : { miles: Math.trunc(ctx.twdBase/customDiv), note:`âš™ï¸ è‡ªè¨‚: $${customDiv}/å“©`, consumedQuota:0 };
            }
            return defCalc();
        };

        db.settings.enabledBuiltins.forEach(cardId => {
            if(CARD_RULES[cardId]) { const res = resolveMiles(cardId, () => CARD_RULES[cardId].calc(ctx)); currentResults.push({ id: cardId, name: CARD_RULES[cardId].name, ...res, twdSpend, twdBase }); }
        });
        db.customCards.forEach(c => {
            const res = resolveMiles(c.id, () => { let div = ctx.isForeign ? c.forRate : c.domRate; return { miles: Math.trunc(ctx.twdBase/div), note: `è‡ªè¨‚ $${div}/å“©`, consumedQuota: 0 }; });
            currentResults.push({ id: c.id, name: c.name, ...res, twdSpend, twdBase });
        });

        if (amt < 0) currentResults.sort((a,b) => a.miles - b.miles);
        else currentResults.sort((a,b) => b.miles - a.miles);
        
        renderResults(currentResults);
    }

    function renderResults(list) {
        const con = document.getElementById('cards-container'); con.innerHTML = '';
        document.getElementById('result-area').style.display = 'block';
        list.forEach((c, idx) => {
            const isWinner = idx === 0 && !c.isWarning; 
            const btnClass = isWinner ? 'btn-record-win' : '';
            const tpm = c.miles > 0 ? (c.twdSpend / c.miles).toFixed(1) : '-';
            const warningClass = c.isWarning ? 'plan-warning' : '';
            
            const div = document.createElement('div'); div.className = `plan-card ${isWinner ? 'plan-winner' : ''} ${warningClass}`;
            div.innerHTML = `
            ${isWinner ? '<span class="winner-badge">WINNER</span>' : ''}
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="card-name">${c.name}</h4>
                    <div class="text-muted small font-hand mt-1" style="line-height:1.4;">${c.note}</div>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn-card-action ${btnClass}" onclick="recordTx(${idx})">ğŸ“ è¨˜å¸³</button>
                        <button class="btn-correct" onclick="openCorrection('${c.id}','${c.name}')"><svg class="lucide"><use href="#icon-pen"/></svg> ä¿®æ­£</button>
                    </div>
                </div>
                <div class="text-end">
                    <div class="card-miles">${c.miles.toLocaleString()} <small style="font-size:0.5em">å“©</small></div>
                    <div class="text-muted small fw-bold">${tpm} å…ƒ/å“©</div>
                </div>
            </div>`;
            con.appendChild(div);
        });
    }

    function recordTx(idx) {
        const item = currentResults[idx]; const db = loadDB(); const now = new Date();
        const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        if(!db.records[monthKey]) db.records[monthKey] = {}; const txId = `tx_${Date.now()}`;
        
        let unitText = 'å“©'; let points = item.miles;
        if(item.id==='hsbc_live') { points = Math.trunc(item.miles/2); unitText='ç©åˆ†'; }
        else if(item.id==='hsbc_inf') { unitText='ç©åˆ†'; }

        // å¯«å…¥ consumedQuota æ¬„ä½ (åªæ¶ˆè€—è§¸ç™¼åŠ ç¢¼çš„é¡åº¦)
        db.records[monthKey][txId] = { id: item.id, name: item.name, spend: item.twdBase, consumedQuota: item.consumedQuota, miles: points, unit: unitText, note: document.getElementById('keyword-input').value || 'ä¸€èˆ¬æ¶ˆè²»' };

        const limitKey = getLimitKey(db, item.id, now);
        if(!db.limits[limitKey]) db.limits[limitKey] = { spend:0, points:0 };
        
        // æ™ºæ…§æ‰£é™¤ï¼šæœ‰è¨­å®š consumedQuota å‰‡ä¾ç…§è©²å€¼æ‰£é™¤ï¼Œå¦å‰‡(ç›¸å®¹èˆŠå¡ç‰‡)æ‰£é™¤å…¨é¡
        let qToConsume = item.consumedQuota !== undefined ? item.consumedQuota : item.twdBase;
        if(qToConsume > 0) { db.limits[limitKey].spend += qToConsume; }
        
        saveDB(db); updateUI(); showAlert(`âœ… å·²åŠ å…¥å¾…çµç®—æ˜ç´°\n${item.name}: ${points>0?'+':''}${points} ${unitText}`);
    }

    function renderList() {
        const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const data = db.records[monthKey] || {}; const con = document.getElementById('transaction-list-container'); con.innerHTML = '';
        
        const groups = {}; let count = 0;
        for(let key in data) { const r = data[key]; if(!groups[r.name]) groups[r.name] = []; groups[r.name].push({ ...r, key }); count++; }
        
        document.getElementById('nav-badge-list').innerText = count;
        document.getElementById('nav-badge-list').style.display = count > 0 ? 'block' : 'none';
        document.getElementById('pending-count').innerText = `${count} ç­†`;

        if(count === 0) { con.innerHTML = '<div class="text-center text-muted py-5">ç›®å‰æ²’æœ‰å¾…çµç®—çš„ç´€éŒ„</div>'; return; }

        for(let name in groups) {
            let html = `<div class="list-group-card"><div class="list-group-header"><span>${name}</span></div><div>`;
            groups[name].forEach(item => {
                html += `
                <div class="list-item">
                    <div class="item-meta">
                        <span>${item.note}</span>
                        <span class="text-muted" style="font-size:0.7rem;">${new Date(parseInt(item.key.split('_')[1])).toLocaleDateString()}</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="item-val">
                            <div class="${item.spend<0?'text-danger':''}">${item.spend.toLocaleString()}</div>
                            <div class="text-primary small">${item.miles>0?'+':''}${item.miles} ${item.unit}</div>
                        </div>
                        <div class="btn-item-del" onclick="delTx('${monthKey}','${item.key}')"><svg class="lucide"><use href="#icon-trash"/></svg></div>
                    </div>
                </div>`;
            });
            html += '</div></div>';
            con.innerHTML += html;
        }
    }

    function delTx(monthKey, txId) {
        showCustomConfirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ<br><small class="text-muted">ï¼ˆåŒæ™‚æœƒé€€é‚„è©²å¡ç‰‡çš„ç´¯ç©é¡åº¦ï¼‰</small>', () => {
            const db = loadDB(); const rec = db.records[monthKey][txId];
            if(rec) { 
                const limitKey = getLimitKey(db, rec.id, new Date()); 
                let qToRestore = rec.consumedQuota !== undefined ? rec.consumedQuota : rec.spend;
                if(db.limits[limitKey]) { db.limits[limitKey].spend -= qToRestore; } 
                delete db.records[monthKey][txId]; 
                saveDB(db); 
                updateUI(); 
            }
        });
    }

    function renderStatus() {
        const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        const data = db.records[monthKey] || {}; const agg = {};
        for(let key in data) { const r = data[key]; if(!agg[r.id]) agg[r.id] = { name: r.name, spend: 0, miles: 0, unit: r.unit }; agg[r.id].spend += r.spend; agg[r.id].miles += r.miles; }
        
        const statusCon = document.getElementById('status-container');
        if(Object.keys(agg).length === 0) statusCon.innerHTML = '<div class="text-center py-3 text-muted">æœ¬æœˆå°šç„¡ç´¯ç©</div>';
        else {
            let h = '';
            for(let id in agg) {
                const item = agg[id]; let u = item.unit; if(!u || u==='undefined') { u = (id.includes('hsbc')) ? 'ç©åˆ†' : 'å“©'; }
                h += `<div class="summary-card"><div><div class="summary-name">${item.name}</div><div class="summary-spend ${item.spend<0?'text-danger':''} ">$${item.spend.toLocaleString()}</div></div><div class="summary-miles">${item.miles.toLocaleString()} <small style="font-size:0.6em">${u}</small></div></div>`;
            }
            statusCon.innerHTML = h;
        }

        const limitsCon = document.getElementById('limits-container'); let lh = '';
        const cards = [];
        db.settings.enabledBuiltins.forEach(id => cards.push({ id, name: BUILTIN_DEFS.find(d=>d.id===id).name, limit: getLimitVal(id) }));
        cards.forEach(c => {
            const lKey = getLimitKey(db, c.id, now); const curr = db.limits[lKey] ? db.limits[lKey].spend : 0; const pct = Math.min(100, (curr/c.limit)*100);
            lh += `<div class="mb-3"><div class="d-flex justify-content-between small mb-1"><strong>${c.name}</strong><span>$${curr.toLocaleString()} / $${c.limit.toLocaleString()}</span></div><div class="progress"><div class="progress-bar ${pct>80?'bg-warning':'bg-success'}" style="width:${pct}%"></div></div></div>`;
        });
        limitsCon.innerHTML = lh;
    }

    function getLimitVal(id) { 
        if(id==='hsbc_live') return 29600; if(id==='ctbc_ci_inf') return 600000; if(id==='taishin_cx') return 1000000; if(id==='ctbc_ci') return 1440000; return 999999; 
    }

    // --- å°è¦½èˆ‡åˆå§‹åŒ– ---
    function switchWarehouseTab(view) {
        document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-btn-${view}`).classList.add('active');
        if (view === 'manage') { 
            document.getElementById('warehouse-view-manage').style.display = 'block'; 
            document.getElementById('warehouse-view-planner').style.display = 'none'; 
            renderWarehouse(); 
        } else { 
            document.getElementById('warehouse-view-manage').style.display = 'none'; 
            document.getElementById('warehouse-view-planner').style.display = 'block'; 
            
            const dateInput = document.getElementById('planner-date');
            if (!dateInput.value) { dateInput.value = new Date().toISOString().split('T')[0]; }
            
            renderPlannerAssets(); 
            runPlannerCalc(); 
        }
    }

    function renderWarehouse() {
        const db = loadDB(); const list = document.getElementById('warehouse-list'); list.innerHTML = '';
        if(db.warehouse.length === 0) { list.innerHTML = '<div class="text-muted text-center py-4">å€‰åº«æ˜¯ç©ºçš„</div>'; return; }
        
        const groups = {};
        db.warehouse.forEach((asset, idx) => {
            const key = asset.targetAirline; if(!groups[key]) groups[key] = { total: 0, items: [] };
            let equiv = 0; if(asset.type === 'airline') { equiv = asset.current; } else { const ratio = (asset.unitMiles / asset.unitPoints); equiv = Math.floor(asset.current * ratio); }
            groups[key].total += equiv; groups[key].items.push({ ...asset, idx });
        });

        for(let key in groups) {
            const g = groups[key]; let itemsHtml = '';
            g.items.forEach(item => {
                itemsHtml += `
                <div class="asset-item">
                    <div class="asset-info">
                        <div class="asset-name fw-bold">${item.name}</div>
                        <div class="asset-detail text-muted small">æŒæœ‰: ${item.current.toLocaleString()} / ä¼°å€¼: ${Math.floor(item.current * (item.unitMiles/item.unitPoints)).toLocaleString()} å“©</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <button class="btn-asset-del me-1" onclick="openEditAsset(${item.idx})"><svg class="lucide text-primary" style="width:1em;height:1em;"><use href="#icon-pen"/></svg></button>
                        <button class="btn-asset-del" onclick="delAsset(${item.idx})"><svg class="lucide text-danger" style="width:1em;height:1em;"><use href="#icon-trash"/></svg></button>
                    </div>
                </div>`;
            });
            const div = document.createElement('div'); div.className = 'airline-group-card';
            div.innerHTML = `<div class="airline-header"><div class="airline-title"><svg class="lucide me-2"><use href="#icon-plane"/></svg>${key}</div><div class="airline-total">${g.total.toLocaleString()} <small style="font-size:0.5em;">å“©(ä¼°)</small></div></div><div class="airline-body p-2">${itemsHtml}</div>`;
            list.appendChild(div);
        }
    }
    
    function addNativeAsset() {
        const name = document.getElementById('native-airline-name').value; const val = parseFloat(document.getElementById('native-current').value);
        if(!name || isNaN(val)) return showAlert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        const db = loadDB(); db.warehouse.push({ type: 'airline', targetAirline: name, name: name, current: val, unitPoints:1, unitMiles:1 }); saveDB(db); renderWarehouse(); document.getElementById('native-airline-name').value=''; document.getElementById('native-current').value='';
    }
    
    function addTransferAsset() {
        const src = document.getElementById('trans-source-name').value; const val = parseFloat(document.getElementById('trans-current').value); const target = document.getElementById('trans-target-airline').value;
        const uP = parseFloat(document.getElementById('trans-unit-points').value); const uM = parseFloat(document.getElementById('trans-unit-miles').value);
        if(!src || !target || isNaN(val) || isNaN(uP) || isNaN(uM)) return showAlert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        const db = loadDB(); db.warehouse.push({ type: 'transfer', targetAirline: target, name: src, current: val, unitPoints: uP, unitMiles: uM }); saveDB(db); renderWarehouse(); document.getElementById('trans-source-name').value=''; document.getElementById('trans-current').value='';
    }

    function delAsset(idx) { showCustomConfirm('ç¢ºå®šè¦åˆªé™¤é€™é …è³‡ç”¢å—ï¼Ÿ', () => { const db = loadDB(); db.warehouse.splice(idx, 1); plannerSelectedAssets.clear(); saveDB(db); renderWarehouse(); }); }
    function openEditAsset(idx) { editAssetTargetIdx = idx; const db = loadDB(); const asset = db.warehouse[idx]; document.getElementById('edit-asset-name').innerText = asset.name; document.getElementById('edit-asset-val').value = asset.current; showModal('editAssetModal'); }
    function saveAssetEdit() { const val = parseFloat(document.getElementById('edit-asset-val').value); if(isNaN(val)) return showAlert('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å€¼'); const db = loadDB(); db.warehouse[editAssetTargetIdx].current = val; saveDB(db); renderWarehouse(); hideModal('editAssetModal'); }
    function batchImport() {
        showCustomConfirm('ç¢ºå®šå°‡æ˜ç´°å…¨éƒ¨å­˜å…¥å€‰åº«ï¼Ÿ', () => {
            const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const data = db.records[monthKey]; if(!data) return;
            for(let k in data) {
                const r = data[k]; const rule = AUTO_ASSETS[r.id];
                if(rule) { let asset = db.warehouse.find(a => a.targetAirline === rule.target); if(!asset) { asset = { type: rule.type, targetAirline: rule.target, name: rule.target, current: 0, unitPoints:rule.unitPoints, unitMiles:rule.unitMiles }; db.warehouse.push(asset); } asset.current += r.miles; }
            }
            db.records[monthKey] = {}; saveDB(db); updateUI(); showAlert('âœ… å·²å…¨éƒ¨å…¥åº«ï¼');
        });
    }
    
    function clearCurrentStats() { 
        showCustomConfirm('ç¢ºå®šè¦é‡ç½®æœ¬æœŸæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ<br><small class="text-muted">ï¼ˆé€™æœƒå°‡æœ¬æœˆç›¸é—œçš„é¡åº¦å…¨éƒ¨é€€é‚„ï¼‰</small>', () => { 
            const db = loadDB(); const now = new Date(); const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            if(db.records[monthKey]) { for(let id in db.records[monthKey]) { const rec = db.records[monthKey][id]; const limitKey = getLimitKey(db, rec.id, now); if(db.limits[limitKey]) { db.limits[limitKey].spend -= rec.spend; } } db.records[monthKey] = {}; saveDB(db); updateUI(); }
        }); 
    }

    function switchPage(p, btn) {
        document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
        document.getElementById(`page-${p}`).style.display='block';
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); btn.classList.add('active');
        if(p==='warehouse') { const isPlanner = document.getElementById('tab-btn-planner').classList.contains('active'); if (isPlanner) switchWarehouseTab('planner'); else switchWarehouseTab('manage'); }
        window.scrollTo(0,0);
    }

    function parseAirlineGroup(name) {
        if (!name) return 'OTHER'; const n = name.toUpperCase();
        if (n.includes('è¯èˆª') || n.includes('ä¸­è¯') || n.includes('CI')) return 'CI';
        if (n.includes('é•·æ¦®') || n.includes('EVA') || n.includes('BR')) return 'BR';
        if (n.includes('åœ‹æ³°') || n.includes('è¬é‡Œé€š') || n.includes('CX') || n.includes('AM')) return 'CX';
        if (n.includes('ANA') || n.includes('å…¨æ—¥ç©º')) return 'ANA';
        return 'OTHER';
    }

    function renderPlannerAssets() {
        const db = loadDB(); const con = document.getElementById('planner-asset-container'); con.innerHTML = '';
        if(db.warehouse.length === 0) { con.innerHTML = '<div class="text-muted small text-center py-3">å€‰åº«ç›®å‰ç„¡è³‡ç”¢<br>è«‹å…ˆåœ¨ä¸Šæ–¹åˆ‡æ›å›ã€Œè³‡ç”¢ç®¡ç†ã€æ–°å¢</div>'; return; }
        db.warehouse.forEach((asset, idx) => {
            const equiv = Math.floor(asset.current * (asset.unitMiles / asset.unitPoints));
            const isSelected = plannerSelectedAssets.has(idx);
            const div = document.createElement('div');
            div.className = `planner-asset-card d-flex justify-content-between align-items-center ${isSelected ? 'selected' : ''}`;
            div.onclick = () => { if(plannerSelectedAssets.has(idx)) plannerSelectedAssets.delete(idx); else plannerSelectedAssets.add(idx); renderPlannerAssets(); runPlannerCalc(); };
            
            const iconRef = asset.type==='airline' ? 'icon-plane' : 'icon-rotate';
            const checkRef = isSelected ? 'icon-check-sq' : 'icon-sq';
            const checkColor = isSelected ? 'text-primary lucide-fill' : 'text-secondary';
            
            div.innerHTML = `
                <div class="d-flex align-items-center gap-2">
                    <div class="planner-airline-logo text-primary flex-shrink-0"><svg class="lucide" style="font-size:0.9em;"><use href="#${iconRef}"/></svg></div>
                    <div><div class="fw-bold text-dark" style="font-size:0.9rem;">${asset.name}</div><div class="text-muted" style="font-size:0.75rem;">ç›®æ¨™: ${asset.targetAirline}</div></div>
                </div>
                <div class="text-end d-flex align-items-center gap-2 flex-shrink-0">
                    <div class="fw-bold ${isSelected ? 'text-primary' : 'text-secondary'} font-hand">${equiv.toLocaleString()} å“©</div>
                    <svg class="lucide ${checkColor}" style="stroke-width:1.5;"><use href="#${checkRef}"/></svg>
                </div>
            `;
            con.appendChild(div);
        });
    }

    // --- æ—¥æœŸå°æ‡‰å­£ç¯€å¼•æ“ (åš´æ ¼æ¯”å°æˆªåœ– 5: æ—¥æœ¬â†”äºæ´²1å€) ---
    function checkAnaSeason(dateStr) {
        if (!dateStr) return 'R';
        const d = new Date(dateStr); const m = d.getMonth() + 1; const day = d.getDate();
        const year = d.getFullYear(); const dateNum = m * 100 + day; 
        
        if (year === 2026) {
            // L: 1/5~2/13, 4/1~4/28, 5/11~6/30
            if ((dateNum >= 105 && dateNum <= 213) || (dateNum >= 401 && dateNum <= 428) || (dateNum >= 511 && dateNum <= 630)) return 'L';
            // H: 1/1~1/4, 4/29~5/10, 7/18~8/23, 12/21~12/31
            if ((dateNum >= 101 && dateNum <= 104) || (dateNum >= 429 && dateNum <= 510) || (dateNum >= 718 && dateNum <= 823) || (dateNum >= 1221 && dateNum <= 1231)) return 'H';
            return 'R';
        }
        if (year === 2025) {
            // L: 1/4~1/27, 4/1~4/23, 5/12~6/30, 12/1~12/14
            if ((dateNum >= 104 && dateNum <= 127) || (dateNum >= 401 && dateNum <= 423) || (dateNum >= 512 && dateNum <= 630) || (dateNum >= 1201 && dateNum <= 1214)) return 'L';
            // H: 1/1~1/3, 4/24~5/11, 7/18~8/24, 12/15~12/31
            if ((dateNum >= 101 && dateNum <= 103) || (dateNum >= 424 && dateNum <= 511) || (dateNum >= 718 && dateNum <= 824) || (dateNum >= 1215 && dateNum <= 1231)) return 'H';
            return 'R';
        }
        if (year === 2027) {
            if (dateNum >= 105 && dateNum <= 203) return 'L';
            if ((dateNum >= 101 && dateNum <= 104) || (dateNum >= 204 && dateNum <= 206)) return 'H';
            return 'R';
        }
        return 'R';
    }

    function swapPlannerDest() { const f = document.getElementById('planner-from'); const t = document.getElementById('planner-to'); const tmp = f.value; f.value = t.value; t.value = tmp; runPlannerCalc(); }
    function togglePlannerTrip() { const cb = document.getElementById('planner-trip-type'); cb.checked = !cb.checked; document.getElementById('trip-label').innerText = cb.checked ? 'ä¾†å› (Round-trip)' : 'å–®ç¨‹ (One-way)'; runPlannerCalc(); }

    function runPlannerCalc() {
        const from = document.getElementById('planner-from').value;
        const to = document.getElementById('planner-to').value;
        const date = document.getElementById('planner-date').value;
        const cls = document.getElementById('planner-class').value;
        const isRT = document.getElementById('planner-trip-type').checked;
        const con = document.getElementById('planner-results-container');
        con.innerHTML = '';

        if (from === to) { con.innerHTML = '<div class="text-center py-4 text-muted font-hand fw-bold">èµ·çµ‚é»ç›¸åŒï¼Œä¸éœ€å“©ç¨‹</div>'; return; }

        const season = checkAnaSeason(date);
        const combo1 = `${from}_${to}`, combo2 = `${to}_${from}`;
        const data = MATRIX_DATA[combo1] || MATRIX_DATA[combo2];

        if (!data) { con.innerHTML = '<div class="text-center py-4 text-muted font-hand">âš ï¸ ç›®å‰å°šæœªå…§å»ºæ­¤è·¨å€èˆªç·šçš„ç²¾ç®—æ•¸æ“š<br>è«‹æ”¹æŸ¥é–±å®˜ç¶²ã€‚</div>'; return; }

        const db = loadDB(); let available = { CI: 0, BR: 0, CX: 0, ANA: 0 };
        plannerSelectedAssets.forEach(idx => { const asset = db.warehouse[idx]; if(!asset) return; const group = parseAirlineGroup(asset.targetAirline); if(available[group] !== undefined) { available[group] += Math.floor(asset.current * (asset.unitMiles / asset.unitPoints)); } });

        const createCard = (airlineKey, name, b64, val, badgeStr) => {
            if (!val) return '';
            let required = (typeof val === 'number') ? val : (val[cls] || -1);
            if (typeof required === 'object') required = required[season];
            
            if (required === -1) {
                return `
                <div class="planner-result-card" style="background:#f8fafc; border-color:#e2e8f0; opacity:0.8;">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-bold text-dark fs-6 d-flex align-items-center">${name} <span class="route-badge ${badgeStr==='ç›´é£›ç‚ºä¸»'?'badge-direct':'badge-transit'}">${badgeStr}</span></div>
                        <div class="fw-bold font-hand fs-5 text-muted">ç„¡å¸¸è¦è‰™ç­‰</div>
                    </div>
                </div>`;
            }
            
            // å–®ç¨‹è¨ˆç®—é‚è¼¯ï¼šç²¾æº–æŠ˜åŠ
            if (!isRT) required = Math.trunc(required / 2);
            
            const availMiles = available[airlineKey] || 0;
            const isEnough = availMiles >= required && required > 0;
            const pct = required > 0 ? Math.min(100, (availMiles / required) * 100) : 0;
            const statusHtml = isEnough ? `<span class="text-success d-flex align-items-center"><svg class="lucide me-1"><use href="#icon-check-c"/></svg> å¯å…Œæ›</span>` : `<span class="text-danger">å°šç¼º ${ (required - availMiles).toLocaleString() }</span>`;
            
            return `
            <div class="planner-result-card ${isEnough ? 'status-enough' : 'status-short'}">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <div class="fw-bold text-dark fs-6 d-flex align-items-center">${name} <span class="route-badge ${badgeStr==='ç›´é£›ç‚ºä¸»'?'badge-direct':'badge-transit'}">${badgeStr}</span></div>
                    <div class="fw-bold font-hand fs-5">${statusHtml}</div>
                </div>
                <div class="d-flex justify-content-between align-items-end mt-2">
                    <div class="text-muted small fw-bold font-hand">
                        <div>æ¨™æº–: ${required.toLocaleString()}</div>
                        <div>å·²é¸: ${availMiles.toLocaleString()}</div>
                    </div>
                    <a href="#" onclick="window.open(atob('${b64}'), '_blank'); return false;" class="link-btn">
                        <svg class="lucide" style="font-size:0.9em;"><use href="#icon-external"/></svg> ç«‹å³å…Œæ›
                    </a>
                </div>
                <div class="progress mt-2"><div class="progress-bar ${isEnough ? 'bg-success' : 'bg-danger'}" style="width: ${pct}%"></div></div>
            </div>`;
        };

        if(data.CI) con.innerHTML += createCard('CI', 'ä¸­è¯èˆªç©º', b64_CI, data.CI, 'ç›´é£›ç‚ºä¸»');
        if(data.BR) con.innerHTML += createCard('BR', 'é•·æ¦®èˆªç©º', b64_BR, data.BR, 'ç›´é£›ç‚ºä¸»');
        if(data.CX) con.innerHTML += createCard('CX', 'åœ‹æ³°èˆªç©º', b64_CX, data.CX, 'ç¶“ HKG è½‰æ©Ÿ');
        
        if(data.NH) {
            let anaSelfName = 'ANA (è‡ªå®¶)';
            let seasonBadge = season === 'L' ? 'æ·¡å­£' : season === 'H' ? 'æ—ºå­£' : 'ä¸€èˆ¬';
            if(cls !== 'F') anaSelfName += ` <span class="route-badge badge-transit" style="margin-left:4px;">${seasonBadge}</span>`;
            con.innerHTML += createCard('ANA', anaSelfName, b64_ANA, data.NH, 'ç¶“ NRT/HND');
            
            let starReq = data.NH[cls];
            if(typeof starReq === 'object') starReq = starReq['R']; // æ˜Ÿç›Ÿå–è¿‘ä¼¼å€¼
            con.innerHTML += createCard('ANA', 'ANA (æ›æ˜Ÿç›Ÿ)', b64_ANA, starReq, 'ç›´é£›ç‚ºä¸»');
        }
    }

    /* =========================
       UI é˜²å‘†èˆ‡å®‰å…¨ä»£ç†ç³»çµ±
       ========================= */
    function showModal(id) { document.getElementById(id).classList.add('show'); }
    function hideModal(id) { document.getElementById(id).classList.remove('show'); }
    
    document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
        btn.onclick = function() { const m = this.closest('.modal'); if(m) { m.classList.remove('show'); } }
    });

    function showCustomConfirm(msg, callback) {
        document.getElementById('confirm-msg').innerHTML = msg;
        pendingConfirmCallback = callback;
        showModal('customConfirmModal');
    }
    document.getElementById('confirm-btn-yes').onclick = function() {
        hideModal('customConfirmModal');
        if(pendingConfirmCallback) pendingConfirmCallback();
    };

    function openCorrection(id, name) { correctionTarget = { id, name }; const k = document.getElementById('keyword-input').value; if(!k) return showAlert('è«‹å…ˆåœ¨ä¸»ç•«é¢è¼¸å…¥ã€Œé—œéµå­—ã€æ‰èƒ½è¨­å®šä¿®æ­£è¦å‰‡'); document.getElementById('modal-card-name').innerText = name; document.getElementById('modal-keyword').innerText = k; document.getElementById('modal-new-rate').value = ''; showModal('correctionModal'); }
    function saveCorrection() { const rate = parseFloat(document.getElementById('modal-new-rate').value); if(isNaN(rate)) return showAlert('è«‹è¼¸å…¥æ•¸å€¼'); const k = document.getElementById('modal-keyword').innerText; const ruleKey = `${k}|${correctionTarget.id}`; const rules = loadRules(); rules[ruleKey] = rate; saveRules(rules); hideModal('correctionModal'); calculate(); }
    function updateUI() { renderList(); renderStatus(); }
    function showAlert(msg) { document.getElementById('alert-msg').innerText=msg; showModal('customAlertModal'); }

    // ã€å…¨æ–° v12.6 å››æ®µå¼æ•™å­¸æ–‡æ¡ˆã€‘
    function openGuide() {
        const content = `
        <div class="guide-slide p-4 mb-4 slide-sage">
            <div class="g-badge bg-white/20 mb-2">Step 1</div><div class="g-title font-black mb-3">ğŸ“ å°ˆæ¥­è¨˜å¸³èˆ‡ç›£æ§</div>
            <ul class="g-list text-sm">
                <li><b>è¨˜å¸³ï¼š</b>è¼¸å…¥æ¶ˆè²»å¾Œé»æ“Šè¨˜å¸³ï¼Œç´€éŒ„å°‡é€²å…¥ã€Œæ˜ç´°ã€åˆ†é ã€‚</li>
                <li><b>æ²–å¸³ï¼š</b>æ˜ç´°æ”¯æ´å–®ç­†åˆªé™¤ï¼Œåˆªé™¤å¾Œæœƒè‡ªå‹•é€€é‚„å¡ç‰‡ç´¯ç©é¡åº¦ã€‚</li>
                <li><b>æ­¸æˆ¶ï¼š</b>ç¢ºèªç„¡èª¤å¾Œï¼Œè‡³ã€Œç›£æ§ã€åˆ†é é»æ“Šã€Œä¸€éµé€²å€‰ã€ï¼Œå³å¯æ­£å¼å­˜å…¥å€‰åº«ã€‚</li>
            </ul>
        </div>
        <div class="guide-slide p-4 mb-4 slide-terra">
            <div class="g-badge bg-white/20 mb-2">v12.6 äº®é»</div><div class="g-title font-black mb-3">ğŸ“ å…¨çƒé›™å‘è¦åŠƒ</div>
            <ul class="g-list text-sm">
                <li><b>æ‰“ç ´é™åˆ¶ï¼š</b>è‡ªç”±é¸æ“‡<b>ã€ŒğŸ›«å‡ºç™¼åœ°ã€</b>èˆ‡<b>ã€ŒğŸ›¬ç›®çš„åœ°ã€</b>ï¼Œæ”¯æ´å…¨æ–°ã€Œä¸­æ¸¯æ¾³ã€å€åŸŸã€‚</li>
                <li><b>å°æ¸¯æˆ°ç¥ï¼š</b>å…§å»ºåœ‹æ³°èˆªç©ºæœ€æ–°æ¨™æº–ï¼ˆå°æ¸¯å–®ç¨‹ 7,000 å“©èµ·ï¼‰ã€‚</li>
                <li><b>ä¸€éµå°èª¿ï¼š</b>é»æ“Šä¸­é–“çš„<b>ã€Œâ‡„ã€</b>åœ–ç¤ºï¼Œç¬é–“åˆ‡æ›å›ç¨‹æˆ–å¤–ç«™å‡ºç™¼ï¼Œè¨ˆç®—è¶…ç›´è¦ºï¼</li>
            </ul>
        </div>
        <div class="guide-slide p-4 mb-4 slide-clay">
            <div class="g-badge bg-white/40 mb-2" style="color:#5e503f;">æ™ºæ…§ç§‘æŠ€</div><div class="g-title font-black mb-3">ğŸ” æ™ºæ…§è©¦ç®—èˆ‡å–®ç¨‹æ–°åˆ¶</div>
            <ul class="g-list text-sm">
                <li><b>ğŸ“… æ—¥æœŸå°èˆªï¼š</b>åªè¦é¸å¥½å‡ºç™¼æ—¥æœŸï¼Œç³»çµ±è‡ªå‹•æ¯”å° 2025-2027 å­£ç¯€è¡¨ï¼Œç²¾æº–åˆ¤å®š ANA æ·¡æ—ºå­£ (L/R/H)ã€‚</li>
                <li><b>ğŸ”„ å–®ç¨‹åˆ‡æ›ï¼š</b>é»æ“Šé–‹é—œå³å¯æŠ˜åŠå“©ç¨‹éœ€æ±‚ï¼Œå…¨é¢æ”¯æ´ 2025 å¹´ ANA åœ‹éš›ç·šå–®ç¨‹å…Œæ›æ–°è¦ã€‚</li>
            </ul>
        </div>
        <div class="guide-slide p-4 mb-4 slide-dusty">
            <div class="g-badge bg-white/20 mb-2">æ¬Šç›Šæé†’</div><div class="g-title font-black mb-3">â˜‘ï¸ è³‡ç”¢æ¯”å°èˆ‡å…è²¬</div>
            <ul class="g-list text-sm">
                <li><b>ç¼ºå£æ¯”å°ï¼š</b>å‹¾é¸æ‚¨æƒ³å‹•ç”¨çš„ã€Œå€‰åº«è³‡ç”¢ã€ï¼Œç³»çµ±è‡ªå‹•é¡¯ç¤ºå°šç¼ºå“©ç¨‹ä¸¦äº®èµ·ç´…/ç¶ ç‡ˆã€‚</li>
            </ul>
            <p class="text-sm mt-3 pt-3 mb-0 border-top border-white border-opacity-25">âš ï¸ <b>æé†’</b>ï¼šé¡¯ç¤ºæ•¸å€¼ç‚ºå®˜æ–¹æ¨™æº–é ä¼°å€¼ã€‚è«‹é»æ“Šã€Œç«‹å³å…Œæ›ã€ç¢ºèªå®˜ç¶²çš„<b>å¯¦éš›ä½ç½®ç‹€æ…‹</b>èˆ‡ç²¾ç¢ºæ¨™æº–ã€‚</p>
        </div>
        `;
        document.getElementById('guide-content').innerHTML = content; showModal('guideModal');
    }
    
    function openSettings() { renderSettings(); showModal('settingsModal'); }
    function renderSettings() {
        const db = loadDB(); document.getElementById('setting-hsbc-autopay').checked = db.settings.hsbc_autopay;
        const builtinCon = document.getElementById('builtin-cards-list'); builtinCon.innerHTML = ''; 
        BUILTIN_DEFS.forEach(def => { const isOn = db.settings.enabledBuiltins.includes(def.id); builtinCon.innerHTML += `<div class="switch-group mb-2"><span class="switch-label">${def.name}</span><input class="form-check-input flex-shrink-0" type="checkbox" ${isOn?'checked':''} onchange="toggleBuiltin('${def.id}')"></div>`; });
        const customCon = document.getElementById('custom-cards-list'); customCon.innerHTML = ''; 
        db.customCards.forEach((c, idx) => { customCon.innerHTML += `<div class="custom-card-item"><div><div class="fw-bold">${c.name}</div></div><button class="btn-outline-danger" onclick="delCustomCard(${idx})"><svg class="lucide"><use href="#icon-trash"/></svg></button></div>`; });
    }
    function updateGlobalSetting(key, val) { const db = loadDB(); db.settings[key] = val; saveDB(db); }
    function toggleBuiltin(id) { const db = loadDB(); const idx = db.settings.enabledBuiltins.indexOf(id); if(idx >= 0) db.settings.enabledBuiltins.splice(idx, 1); else db.settings.enabledBuiltins.push(id); saveDB(db); }
    function addCustomCard() { const name = document.getElementById('new-card-name').value; const dom = parseFloat(document.getElementById('new-card-dom').value); const fore = parseFloat(document.getElementById('new-card-for').value); if(!name || isNaN(dom)) return; const db = loadDB(); db.customCards.push({ id:`cust_${Date.now()}`, name, domRate:dom, forRate:fore }); saveDB(db); renderSettings(); }
    function delCustomCard(idx) { 
        showCustomConfirm(`ç¢ºå®šè¦åˆªé™¤è‡ªè¨‚å¡ç‰‡ã€Œ${loadDB().customCards[idx].name}ã€å—ï¼Ÿ`, () => {
            const db = loadDB(); db.customCards.splice(idx, 1); saveDB(db); renderSettings();
        });
    }

    window.onload = function() { 
        autoFixMissingCards(); updateUI(); toggleFxInput('TWD'); switchWarehouseTab('manage'); 
    };
  </script>
</body>
</html>


